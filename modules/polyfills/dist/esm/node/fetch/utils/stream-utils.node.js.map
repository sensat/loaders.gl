{"version":3,"file":"stream-utils.node.js","names":["zlib","toArrayBuffer","decompressReadStream","readStream","headers","get","pipe","createBrotliDecompress","createGunzip","createDeflate","concatenateReadStream","arrayBufferChunks","Promise","resolve","reject","on","error","read","chunk","Error","push","arrayBuffer","concatenateArrayBuffers","sources","sourceArrays","map","source2","ArrayBuffer","Uint8Array","byteLength","reduce","length","typedArray","result","offset","sourceArray","set","buffer"],"sources":["../../../../../src/node/fetch/utils/stream-utils.node.ts"],"sourcesContent":["// loaders.gl, MIT license\n\nimport zlib from 'zlib';\n\nimport {toArrayBuffer} from './decode-data-uri.node';\n\n/**\n *\n */\nexport function decompressReadStream(readStream, headers) {\n  switch (headers.get('content-encoding')) {\n    case 'br':\n      return readStream.pipe(zlib.createBrotliDecompress());\n    case 'gzip':\n      return readStream.pipe(zlib.createGunzip());\n    case 'deflate':\n      return readStream.pipe(zlib.createDeflate());\n    default:\n      // No compression or an unknown one, just return it as is\n      return readStream;\n  }\n}\n\n/**\n *\n * @param readStream\n * @returns\n */\nexport async function concatenateReadStream(readStream): Promise<ArrayBuffer> {\n  const arrayBufferChunks: ArrayBuffer[] = [];\n\n  return await new Promise((resolve, reject) => {\n    readStream.on('error', (error) => reject(error));\n\n    // Once the readable callback has been added, stream switches to \"flowing mode\"\n    // In Node 10 (but not 12 and 14) this causes `data` and `end` to never be called unless we read data here\n    readStream.on('readable', () => readStream.read());\n\n    readStream.on('data', (chunk) => {\n      if (typeof chunk === 'string') {\n        reject(new Error('Read stream not binary'));\n      }\n      arrayBufferChunks.push(toArrayBuffer(chunk));\n    });\n\n    readStream.on('end', () => {\n      const arrayBuffer = concatenateArrayBuffers(arrayBufferChunks);\n      resolve(arrayBuffer);\n    });\n  });\n}\n\n/**\n * Concatenate a sequence of ArrayBuffers\n * @return A concatenated ArrayBuffer\n * @note duplicates loader-utils since polyfills should be independent\n */\nexport function concatenateArrayBuffers(sources: (ArrayBuffer | Uint8Array)[]): ArrayBuffer {\n  // Make sure all inputs are wrapped in typed arrays\n  const sourceArrays = sources.map((source2) =>\n    source2 instanceof ArrayBuffer ? new Uint8Array(source2) : source2\n  );\n\n  // Get length of all inputs\n  const byteLength = sourceArrays.reduce((length, typedArray) => length + typedArray.byteLength, 0);\n\n  // Allocate array with space for all inputs\n  const result = new Uint8Array(byteLength);\n\n  // Copy the subarrays\n  let offset = 0;\n  for (const sourceArray of sourceArrays) {\n    result.set(sourceArray, offset);\n    offset += sourceArray.byteLength;\n  }\n\n  // We work with ArrayBuffers, discard the typed array wrapper\n  return result.buffer;\n}\n"],"mappings":"AAEA,OAAOA,IAAI,MAAM,MAAM;AAEvB,SAAQC,aAAa,QAAO,wBAAwB;AAKpD,OAAO,SAASC,oBAAoBA,CAACC,UAAU,EAAEC,OAAO,EAAE;EACxD,QAAQA,OAAO,CAACC,GAAG,CAAC,kBAAkB,CAAC;IACrC,KAAK,IAAI;MACP,OAAOF,UAAU,CAACG,IAAI,CAACN,IAAI,CAACO,sBAAsB,CAAC,CAAC,CAAC;IACvD,KAAK,MAAM;MACT,OAAOJ,UAAU,CAACG,IAAI,CAACN,IAAI,CAACQ,YAAY,CAAC,CAAC,CAAC;IAC7C,KAAK,SAAS;MACZ,OAAOL,UAAU,CAACG,IAAI,CAACN,IAAI,CAACS,aAAa,CAAC,CAAC,CAAC;IAC9C;MAEE,OAAON,UAAU;EACrB;AACF;AAOA,OAAO,eAAeO,qBAAqBA,CAACP,UAAU,EAAwB;EAC5E,MAAMQ,iBAAgC,GAAG,EAAE;EAE3C,OAAO,MAAM,IAAIC,OAAO,CAAC,CAACC,OAAO,EAAEC,MAAM,KAAK;IAC5CX,UAAU,CAACY,EAAE,CAAC,OAAO,EAAGC,KAAK,IAAKF,MAAM,CAACE,KAAK,CAAC,CAAC;IAIhDb,UAAU,CAACY,EAAE,CAAC,UAAU,EAAE,MAAMZ,UAAU,CAACc,IAAI,CAAC,CAAC,CAAC;IAElDd,UAAU,CAACY,EAAE,CAAC,MAAM,EAAGG,KAAK,IAAK;MAC/B,IAAI,OAAOA,KAAK,KAAK,QAAQ,EAAE;QAC7BJ,MAAM,CAAC,IAAIK,KAAK,CAAC,wBAAwB,CAAC,CAAC;MAC7C;MACAR,iBAAiB,CAACS,IAAI,CAACnB,aAAa,CAACiB,KAAK,CAAC,CAAC;IAC9C,CAAC,CAAC;IAEFf,UAAU,CAACY,EAAE,CAAC,KAAK,EAAE,MAAM;MACzB,MAAMM,WAAW,GAAGC,uBAAuB,CAACX,iBAAiB,CAAC;MAC9DE,OAAO,CAACQ,WAAW,CAAC;IACtB,CAAC,CAAC;EACJ,CAAC,CAAC;AACJ;AAOA,OAAO,SAASC,uBAAuBA,CAACC,OAAqC,EAAe;EAE1F,MAAMC,YAAY,GAAGD,OAAO,CAACE,GAAG,CAAEC,OAAO,IACvCA,OAAO,YAAYC,WAAW,GAAG,IAAIC,UAAU,CAACF,OAAO,CAAC,GAAGA,OAC7D,CAAC;EAGD,MAAMG,UAAU,GAAGL,YAAY,CAACM,MAAM,CAAC,CAACC,MAAM,EAAEC,UAAU,KAAKD,MAAM,GAAGC,UAAU,CAACH,UAAU,EAAE,CAAC,CAAC;EAGjG,MAAMI,MAAM,GAAG,IAAIL,UAAU,CAACC,UAAU,CAAC;EAGzC,IAAIK,MAAM,GAAG,CAAC;EACd,KAAK,MAAMC,WAAW,IAAIX,YAAY,EAAE;IACtCS,MAAM,CAACG,GAAG,CAACD,WAAW,EAAED,MAAM,CAAC;IAC/BA,MAAM,IAAIC,WAAW,CAACN,UAAU;EAClC;EAGA,OAAOI,MAAM,CAACI,MAAM;AACtB"}