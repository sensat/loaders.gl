{"version":3,"file":"encode-image.node.js","names":["savePixels","ndarray","bufferToArrayBuffer","encodeImageToStreamNode","image","options","type","replace","pixels","data","width","height","encodeImageNode","imageStream","Promise","resolve","buffers","on","buffer","push","Buffer","concat"],"sources":["../../../../src/node/images/encode-image.node.ts"],"sourcesContent":["// Use stackgl modules for DOM-less reading and writing of images\n\nimport savePixels from 'save-pixels';\nimport ndarray from 'ndarray';\nimport {bufferToArrayBuffer} from '../buffer/to-array-buffer.node';\n\n/**\n * Returns data bytes representing a compressed image in PNG or JPG format,\n * This data can be saved using file system (f) methods or\n * used in a request.\n * @param image to save\n * @param options\n * @param options.type='png' - png, jpg or image/png, image/jpg are valid\n * @param options.dataURI - Whether to include a data URI header\n * @return {*} bytes\n */\nexport function encodeImageToStreamNode(\n  image: {data: any; width: number; height: number},\n  options: {type?: string; dataURI?: string}\n) {\n  // Support MIME type strings\n  const type = options.type ? options.type.replace('image/', '') : 'jpeg';\n  const pixels = ndarray(image.data, [image.width, image.height, 4], [4, image.width * 4, 1], 0);\n\n  // Note: savePixels returns a stream\n  return savePixels(pixels, type, options);\n}\n\nexport function encodeImageNode(image, options) {\n  const imageStream = encodeImageToStreamNode(image, options);\n\n  return new Promise((resolve) => {\n    const buffers: any[] = [];\n    imageStream.on('data', (buffer) => buffers.push(buffer));\n    // TODO - convert to arraybuffer?\n    imageStream.on('end', () => {\n      const buffer = Buffer.concat(buffers);\n      resolve(bufferToArrayBuffer(buffer));\n    });\n  });\n}\n"],"mappings":"AAEA,OAAOA,UAAU,MAAM,aAAa;AACpC,OAAOC,OAAO,MAAM,SAAS;AAC7B,SAAQC,mBAAmB,QAAO,gCAAgC;AAYlE,OAAO,SAASC,uBAAuBA,CACrCC,KAAiD,EACjDC,OAA0C,EAC1C;EAEA,MAAMC,IAAI,GAAGD,OAAO,CAACC,IAAI,GAAGD,OAAO,CAACC,IAAI,CAACC,OAAO,CAAC,QAAQ,EAAE,EAAE,CAAC,GAAG,MAAM;EACvE,MAAMC,MAAM,GAAGP,OAAO,CAACG,KAAK,CAACK,IAAI,EAAE,CAACL,KAAK,CAACM,KAAK,EAAEN,KAAK,CAACO,MAAM,EAAE,CAAC,CAAC,EAAE,CAAC,CAAC,EAAEP,KAAK,CAACM,KAAK,GAAG,CAAC,EAAE,CAAC,CAAC,EAAE,CAAC,CAAC;EAG9F,OAAOV,UAAU,CAACQ,MAAM,EAAEF,IAAI,EAAED,OAAO,CAAC;AAC1C;AAEA,OAAO,SAASO,eAAeA,CAACR,KAAK,EAAEC,OAAO,EAAE;EAC9C,MAAMQ,WAAW,GAAGV,uBAAuB,CAACC,KAAK,EAAEC,OAAO,CAAC;EAE3D,OAAO,IAAIS,OAAO,CAAEC,OAAO,IAAK;IAC9B,MAAMC,OAAc,GAAG,EAAE;IACzBH,WAAW,CAACI,EAAE,CAAC,MAAM,EAAGC,MAAM,IAAKF,OAAO,CAACG,IAAI,CAACD,MAAM,CAAC,CAAC;IAExDL,WAAW,CAACI,EAAE,CAAC,KAAK,EAAE,MAAM;MAC1B,MAAMC,MAAM,GAAGE,MAAM,CAACC,MAAM,CAACL,OAAO,CAAC;MACrCD,OAAO,CAACb,mBAAmB,CAACgB,MAAM,CAAC,CAAC;IACtC,CAAC,CAAC;EACJ,CAAC,CAAC;AACJ"}