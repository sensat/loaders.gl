{"version":3,"file":"octree.js","names":["PointCloudOctree","constructor","url","octreeDir","spacing","boundingBox","root","nodes","pointAttributes","hierarchyStepSize","loader","PointCloudOctant","name","octree","id","PointCloudOctreeGeometryNode","IDCount","index","parseInt","charAt","length","geometry","boundingSphere","getBoundingSphere","THREE","Sphere","children","numPoints","level","loaded","oneTimeDisposeHandlers","isGeometryNode","getLevel","isTreeNode","isLoaded","getBoundingBox","getChildren","filter","Boolean","getURL","version","hierarchyPath","concat","getHierarchyPath","path","indices","substr","numParts","Math","floor","i","slice","addChild","child","parent","load","loading","Potree","numNodesLoading","maxNodesLoading","equalOrHigher","hasChildren","loadHierachyThenPoints","loadPoints","node","callback","hbuffer","view","DataView","stack","getUint8","getUint32","push","decoded","offset","snode","shift","mask","childName","childChildren","childNumPoints","byteLength","pco","pcoGeometry","decodedNumPoints","parentName","substring","parentNode","Utils","createChildAABB","currentNode","pow","hurl","xhr","XHRFactory","createXMLHttpRequest","open","responseType","overrideMimeType","onreadystatechange","readyState","status","response","console","log","send","e","getNumPoints","dispose","handler"],"sources":["../../../src/lib/octree.ts"],"sourcesContent":["/* eslint-disable */\n\n// @ts-nocheck\n\nexport class PointCloudOctree {\n  constructor() {\n    this.url = null;\n    this.octreeDir = null;\n    this.spacing = 0;\n    this.boundingBox = null;\n    this.root = null;\n    this.nodes = null;\n    this.pointAttributes = null;\n    this.hierarchyStepSize = -1;\n    this.loader = null;\n  }\n}\n\nexport class PointCloudOctant {\n  constructor(name, octree, boundingBox) {\n    this.octree = this.id = PointCloudOctreeGeometryNode.IDCount++;\n    this.name = name;\n    this.index = parseInt(name.charAt(name.length - 1));\n    this.octree = octree;\n    this.geometry = null;\n    this.boundingBox = boundingBox;\n    this.boundingSphere = boundingBox.getBoundingSphere(new THREE.Sphere());\n    this.children = {};\n    this.numPoints = 0;\n    this.level = null;\n    this.loaded = false;\n    this.oneTimeDisposeHandlers = [];\n  }\n\n  isGeometryNode() {\n    return true;\n  }\n\n  getLevel() {\n    return this.level;\n  }\n\n  isTreeNode() {\n    return false;\n  }\n\n  isLoaded() {\n    return this.loaded;\n  }\n\n  getBoundingSphere() {\n    return this.boundingSphere;\n  }\n\n  getBoundingBox() {\n    return this.boundingBox;\n  }\n\n  getChildren() {\n    // Children is a length 8 array with nulls for \"missing\" octants\n    return this.children.filter(Boolean);\n  }\n\n  getURL() {\n    const {version} = this.octree;\n    const hierarchyPath = version >= 1.5 ? `${this.getHierarchyPath()}/` : '';\n    return `${this.octree.octreeDir}/${hierarchyPath}${this.name}`;\n  }\n\n  getHierarchyPath() {\n    let path = 'r/';\n\n    let hierarchyStepSize = this.octree.hierarchyStepSize;\n    let indices = this.name.substr(1);\n\n    let numParts = Math.floor(indices.length / hierarchyStepSize);\n    for (let i = 0; i < numParts; i++) {\n      path += indices.substr(i * hierarchyStepSize, hierarchyStepSize) + '/';\n    }\n\n    path = path.slice(0, -1);\n\n    return path;\n  }\n\n  addChild(child) {\n    this.children[child.index] = child;\n    child.parent = this;\n  }\n\n  load() {\n    if (\n      this.loading === true ||\n      this.loaded === true ||\n      Potree.numNodesLoading >= Potree.maxNodesLoading\n    ) {\n      return;\n    }\n\n    this.loading = true;\n\n    Potree.numNodesLoading++;\n\n    if (this.octree.loader.version.equalOrHigher('1.5')) {\n      if (this.level % this.octree.hierarchyStepSize === 0 && this.hasChildren) {\n        this.loadHierachyThenPoints();\n      } else {\n        this.loadPoints();\n      }\n    } else {\n      this.loadPoints();\n    }\n  }\n\n  loadPoints() {\n    this.octree.loader.load(this);\n  }\n\n  loadHierachyThenPoints() {\n    let node = this;\n\n    // load hierarchy\n    let callback = function (node, hbuffer) {\n      let view = new DataView(hbuffer);\n\n      let stack = [];\n      let children = view.getUint8(0);\n      let numPoints = view.getUint32(1, true);\n      node.numPoints = numPoints;\n      stack.push({children: children, numPoints: numPoints, name: node.name});\n\n      let decoded = [];\n\n      let offset = 5;\n      while (stack.length > 0) {\n        let snode = stack.shift();\n        let mask = 1;\n        for (let i = 0; i < 8; i++) {\n          if ((snode.children & mask) !== 0) {\n            let childName = snode.name + i;\n\n            let childChildren = view.getUint8(offset);\n            let childNumPoints = view.getUint32(offset + 1, true);\n\n            stack.push({children: childChildren, numPoints: childNumPoints, name: childName});\n\n            decoded.push({children: childChildren, numPoints: childNumPoints, name: childName});\n\n            offset += 5;\n          }\n\n          mask = mask * 2;\n        }\n\n        if (offset === hbuffer.byteLength) {\n          break;\n        }\n      }\n\n      // console.log(decoded);\n\n      let nodes = {};\n      nodes[node.name] = node;\n      let pco = node.pcoGeometry;\n\n      for (let i = 0; i < decoded.length; i++) {\n        let name = decoded[i].name;\n        let decodedNumPoints = decoded[i].numPoints;\n        let index = parseInt(name.charAt(name.length - 1));\n        let parentName = name.substring(0, name.length - 1);\n        let parentNode = nodes[parentName];\n        let level = name.length - 1;\n        let boundingBox = Utils.createChildAABB(parentNode.boundingBox, index);\n\n        let currentNode = new PointCloudOctreeGeometryNode(name, pco, boundingBox);\n        currentNode.level = level;\n        currentNode.numPoints = decodedNumPoints;\n        currentNode.hasChildren = decoded[i].children > 0;\n        currentNode.spacing = pco.spacing / Math.pow(2, level);\n        parentNode.addChild(currentNode);\n        nodes[name] = currentNode;\n      }\n\n      node.loadPoints();\n    };\n    if (node.level % node.pcoGeometry.hierarchyStepSize === 0) {\n      // let hurl = node.pcoGeometry.octreeDir + \"/../hierarchy/\" + node.name + \".hrc\";\n      let hurl =\n        node.pcoGeometry.octreeDir + '/' + node.getHierarchyPath() + '/' + node.name + '.hrc';\n\n      let xhr = XHRFactory.createXMLHttpRequest();\n      xhr.open('GET', hurl, true);\n      xhr.responseType = 'arraybuffer';\n      xhr.overrideMimeType('text/plain; charset=x-user-defined');\n      xhr.onreadystatechange = () => {\n        if (xhr.readyState === 4) {\n          if (xhr.status === 200 || xhr.status === 0) {\n            let hbuffer = xhr.response;\n            callback(node, hbuffer);\n          } else {\n            console.log('Failed to load file! HTTP status: ' + xhr.status + ', file: ' + hurl);\n            Potree.numNodesLoading--;\n          }\n        }\n      };\n      try {\n        xhr.send(null);\n      } catch (e) {\n        console.log('fehler beim laden der punktwolke: ' + e);\n      }\n    }\n  }\n\n  getNumPoints() {\n    return this.numPoints;\n  }\n\n  dispose() {\n    if (this.geometry && this.parent != null) {\n      this.geometry.dispose();\n      this.geometry = null;\n      this.loaded = false;\n\n      // this.dispatchEvent( { type: 'dispose' } );\n      for (let i = 0; i < this.oneTimeDisposeHandlers.length; i++) {\n        let handler = this.oneTimeDisposeHandlers[i];\n        handler();\n      }\n      this.oneTimeDisposeHandlers = [];\n    }\n  }\n}\n\nPointCloudOctreeGeometryNode.IDCount = 0;\n"],"mappings":"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"}