{"version":3,"file":"deps-installer.js","names":["load","fetchFile","ZipLoader","writeFile","join","ChildProcessProxy","VERSION","PGM_LINK","DepsInstaller","install","path","arguments","length","undefined","workersPath","console","log","fileMap","depsPath","process","cwd","Uint8Array","installWorker","childProcess","start","command","wait","module","name","extraPath","fileResponse","concat","fileData","arrayBuffer"],"sources":["../../../src/deps-installer/deps-installer.ts"],"sourcesContent":["import {load, fetchFile} from '@loaders.gl/core';\nimport {ZipLoader} from '@loaders.gl/zip';\nimport {writeFile} from '../lib/utils/file-utils';\nimport {join} from 'path';\nimport {ChildProcessProxy} from '@loaders.gl/worker-utils';\n\n// @ts-ignore TS2304: Cannot find name '__VERSION__'.\nconst VERSION = typeof __VERSION__ !== 'undefined' ? __VERSION__ : 'beta';\n\nconst PGM_LINK = 'https://raw.githubusercontent.com/visgl/deck.gl-data/master/egm/egm2008-5.zip';\n\n/**\n * Install external dependencies for converter:\n * * PGM file (implemented);\n * * Draco library (not implemented);\n * * 7z archiver (not implemented);\n */\nexport class DepsInstaller {\n  /**\n   * Run instalation\n   * @param path destination folder\n   * @param workersPath destination folder for workers.\n   *    This path is '' by default and is not used by tile-converter.\n   *    It is used in tests to prevent rewriting actual workers during tests running\n   */\n  async install(path: string = '', workersPath: string = ''): Promise<void> {\n    console.log('Installing \"EGM2008-5\" model...'); // eslint-disable-line no-console\n    const fileMap = await load(PGM_LINK, ZipLoader, {});\n\n    let depsPath = process.cwd();\n    if (path) {\n      depsPath = join(depsPath, path);\n    }\n\n    await writeFile(depsPath, new Uint8Array(fileMap['geoids/egm2008-5.pgm']), 'egm2008-5.pgm');\n\n    console.log('Installing \"I3S Content Loader worker\"'); // eslint-disable-line no-console\n    await this.installWorker('i3s', 'i3s-content-worker-node.js', workersPath);\n\n    console.log('Installing \"Draco Loader worker\"'); // eslint-disable-line no-console\n    await this.installWorker('draco', 'draco-worker-node.js', workersPath);\n\n    console.log('Installing \"Basis Loader worker\"'); // eslint-disable-line no-console\n    await this.installWorker('textures', 'basis-worker-node.js', workersPath);\n\n    console.log('Installing \"join-images\" npm package');\n    const childProcess = new ChildProcessProxy();\n    await childProcess.start({\n      command: 'npm',\n      // `npm install sharp join-images` works unstable. It fails because installed `sharp` version\n      // may be different from the version required by `join-images`. Pointing to specific versions\n      // resolve this issue\n      arguments: ['install', 'sharp@0.30.4', 'join-images@1.1.3'],\n      wait: 0\n    });\n\n    console.log('All dependencies were installed succesfully.'); // eslint-disable-line no-console\n  }\n\n  private async installWorker(module: string, name: string, extraPath: string) {\n    const fileResponse = await fetchFile(\n      `https://unpkg.com/@loaders.gl/${module}@${VERSION}/dist/${name}`\n    );\n    const fileData = await fileResponse.arrayBuffer();\n    if (!fileData) {\n      return;\n    }\n    const path = join(process.cwd(), extraPath, 'modules', module, 'dist');\n    await writeFile(path, fileData, name);\n  }\n}\n"],"mappings":"AAAA,SAAQA,IAAI,EAAEC,SAAS,QAAO,kBAAkB;AAChD,SAAQC,SAAS,QAAO,iBAAiB;AACzC,SAAQC,SAAS,QAAO,yBAAyB;AACjD,SAAQC,IAAI,QAAO,MAAM;AACzB,SAAQC,iBAAiB,QAAO,0BAA0B;AAG1D,MAAMC,OAAO,GAAG,sBAAkB,KAAK,WAAW,qBAAiB,MAAM;AAEzE,MAAMC,QAAQ,GAAG,+EAA+E;AAQhG,OAAO,MAAMC,aAAa,CAAC;EAQzB,MAAMC,OAAOA,CAAA,EAA6D;IAAA,IAA5DC,IAAY,GAAAC,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAG,EAAE;IAAA,IAAEG,WAAmB,GAAAH,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAG,EAAE;IACvDI,OAAO,CAACC,GAAG,CAAC,iCAAiC,CAAC;IAC9C,MAAMC,OAAO,GAAG,MAAMjB,IAAI,CAACO,QAAQ,EAAEL,SAAS,EAAE,CAAC,CAAC,CAAC;IAEnD,IAAIgB,QAAQ,GAAGC,OAAO,CAACC,GAAG,CAAC,CAAC;IAC5B,IAAIV,IAAI,EAAE;MACRQ,QAAQ,GAAGd,IAAI,CAACc,QAAQ,EAAER,IAAI,CAAC;IACjC;IAEA,MAAMP,SAAS,CAACe,QAAQ,EAAE,IAAIG,UAAU,CAACJ,OAAO,CAAC,sBAAsB,CAAC,CAAC,EAAE,eAAe,CAAC;IAE3FF,OAAO,CAACC,GAAG,CAAC,wCAAwC,CAAC;IACrD,MAAM,IAAI,CAACM,aAAa,CAAC,KAAK,EAAE,4BAA4B,EAAER,WAAW,CAAC;IAE1EC,OAAO,CAACC,GAAG,CAAC,kCAAkC,CAAC;IAC/C,MAAM,IAAI,CAACM,aAAa,CAAC,OAAO,EAAE,sBAAsB,EAAER,WAAW,CAAC;IAEtEC,OAAO,CAACC,GAAG,CAAC,kCAAkC,CAAC;IAC/C,MAAM,IAAI,CAACM,aAAa,CAAC,UAAU,EAAE,sBAAsB,EAAER,WAAW,CAAC;IAEzEC,OAAO,CAACC,GAAG,CAAC,sCAAsC,CAAC;IACnD,MAAMO,YAAY,GAAG,IAAIlB,iBAAiB,CAAC,CAAC;IAC5C,MAAMkB,YAAY,CAACC,KAAK,CAAC;MACvBC,OAAO,EAAE,KAAK;MAIdd,SAAS,EAAE,CAAC,SAAS,EAAE,cAAc,EAAE,mBAAmB,CAAC;MAC3De,IAAI,EAAE;IACR,CAAC,CAAC;IAEFX,OAAO,CAACC,GAAG,CAAC,8CAA8C,CAAC;EAC7D;EAEA,MAAcM,aAAaA,CAACK,MAAc,EAAEC,IAAY,EAAEC,SAAiB,EAAE;IAC3E,MAAMC,YAAY,GAAG,MAAM7B,SAAS,kCAAA8B,MAAA,CACDJ,MAAM,OAAAI,MAAA,CAAIzB,OAAO,YAAAyB,MAAA,CAASH,IAAI,CACjE,CAAC;IACD,MAAMI,QAAQ,GAAG,MAAMF,YAAY,CAACG,WAAW,CAAC,CAAC;IACjD,IAAI,CAACD,QAAQ,EAAE;MACb;IACF;IACA,MAAMtB,IAAI,GAAGN,IAAI,CAACe,OAAO,CAACC,GAAG,CAAC,CAAC,EAAES,SAAS,EAAE,SAAS,EAAEF,MAAM,EAAE,MAAM,CAAC;IACtE,MAAMxB,SAAS,CAACO,IAAI,EAAEsB,QAAQ,EAAEJ,IAAI,CAAC;EACvC;AACF"}