{"version":3,"file":"deps-installer.js","names":["_core","require","_zip","_fileUtils","_path","_workerUtils","VERSION","PGM_LINK","DepsInstaller","_classCallCheck2","default","_createClass2","key","value","_install","_asyncToGenerator2","_regenerator","mark","_callee","path","workersPath","fileMap","depsPath","childProcess","_args","arguments","wrap","_callee$","_context","prev","next","length","undefined","console","log","load","ZipLoader","sent","process","cwd","join","writeFile","Uint8Array","installWorker","ChildProcessProxy","start","command","wait","stop","install","apply","_installWorker","_callee2","module","name","extraPath","fileResponse","fileData","_callee2$","_context2","fetchFile","concat","arrayBuffer","abrupt","_x","_x2","_x3","exports"],"sources":["../../../src/deps-installer/deps-installer.ts"],"sourcesContent":["import {load, fetchFile} from '@loaders.gl/core';\nimport {ZipLoader} from '@loaders.gl/zip';\nimport {writeFile} from '../lib/utils/file-utils';\nimport {join} from 'path';\nimport {ChildProcessProxy} from '@loaders.gl/worker-utils';\n\n// @ts-ignore TS2304: Cannot find name '__VERSION__'.\nconst VERSION = typeof __VERSION__ !== 'undefined' ? __VERSION__ : 'beta';\n\nconst PGM_LINK = 'https://raw.githubusercontent.com/visgl/deck.gl-data/master/egm/egm2008-5.zip';\n\n/**\n * Install external dependencies for converter:\n * * PGM file (implemented);\n * * Draco library (not implemented);\n * * 7z archiver (not implemented);\n */\nexport class DepsInstaller {\n  /**\n   * Run instalation\n   * @param path destination folder\n   * @param workersPath destination folder for workers.\n   *    This path is '' by default and is not used by tile-converter.\n   *    It is used in tests to prevent rewriting actual workers during tests running\n   */\n  async install(path: string = '', workersPath: string = ''): Promise<void> {\n    console.log('Installing \"EGM2008-5\" model...'); // eslint-disable-line no-console\n    const fileMap = await load(PGM_LINK, ZipLoader, {});\n\n    let depsPath = process.cwd();\n    if (path) {\n      depsPath = join(depsPath, path);\n    }\n\n    await writeFile(depsPath, new Uint8Array(fileMap['geoids/egm2008-5.pgm']), 'egm2008-5.pgm');\n\n    console.log('Installing \"I3S Content Loader worker\"'); // eslint-disable-line no-console\n    await this.installWorker('i3s', 'i3s-content-worker-node.js', workersPath);\n\n    console.log('Installing \"Draco Loader worker\"'); // eslint-disable-line no-console\n    await this.installWorker('draco', 'draco-worker-node.js', workersPath);\n\n    console.log('Installing \"Basis Loader worker\"'); // eslint-disable-line no-console\n    await this.installWorker('textures', 'basis-worker-node.js', workersPath);\n\n    console.log('Installing \"join-images\" npm package');\n    const childProcess = new ChildProcessProxy();\n    await childProcess.start({\n      command: 'npm',\n      // `npm install sharp join-images` works unstable. It fails because installed `sharp` version\n      // may be different from the version required by `join-images`. Pointing to specific versions\n      // resolve this issue\n      arguments: ['install', 'sharp@0.30.4', 'join-images@1.1.3'],\n      wait: 0\n    });\n\n    console.log('All dependencies were installed succesfully.'); // eslint-disable-line no-console\n  }\n\n  private async installWorker(module: string, name: string, extraPath: string) {\n    const fileResponse = await fetchFile(\n      `https://unpkg.com/@loaders.gl/${module}@${VERSION}/dist/${name}`\n    );\n    const fileData = await fileResponse.arrayBuffer();\n    if (!fileData) {\n      return;\n    }\n    const path = join(process.cwd(), extraPath, 'modules', module, 'dist');\n    await writeFile(path, fileData, name);\n  }\n}\n"],"mappings":"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"}