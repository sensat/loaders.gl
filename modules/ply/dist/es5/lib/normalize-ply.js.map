{"version":3,"file":"normalize-ply.js","names":["_schema","require","_getPlySchema","normalizePLY","plyHeader","plyAttributes","options","attributes","getMeshAttributes","boundingBox","getMeshBoundingBox","vertexCount","indices","length","vertices","isTriangles","mode","topology","schema","getPLYSchema","plyMesh","loader","loaderData","header","value","Uint32Array","size","accessors","_i","_Object$keys","Object","keys","attributeName","POSITION","Float32Array","normals","NORMAL","uvs","TEXCOORD_0","colors","COLOR_0","Uint8Array","normalized"],"sources":["../../../src/lib/normalize-ply.ts"],"sourcesContent":["import type {MeshAttributes} from '@loaders.gl/schema';\nimport {getMeshBoundingBox} from '@loaders.gl/schema';\nimport type {PLYMesh, PLYHeader, PLYAttributes, MeshHeader} from './ply-types';\nimport {getPLYSchema} from './get-ply-schema';\n\n/**\n * @param header\n * @param attributes\n * @returns data and header\n */\nexport default function normalizePLY(\n  plyHeader: MeshHeader & PLYHeader,\n  plyAttributes: PLYAttributes,\n  options?: {}\n): PLYMesh {\n  const attributes = getMeshAttributes(plyAttributes);\n  const boundingBox = getMeshBoundingBox(attributes);\n  const vertexCount = plyAttributes.indices.length || plyAttributes.vertices.length / 3;\n\n  // TODO - how to detect POINT CLOUDS vs MESHES?\n  // TODO - For Meshes, PLY quadrangles must be split?\n  const isTriangles = plyAttributes.indices && plyAttributes.indices.length > 0;\n  const mode = isTriangles ? 4 : 0; // TRIANGLES vs POINTS\n  const topology = isTriangles ? 'triangle-list' : 'point-list';\n\n  const schema = getPLYSchema(plyHeader, attributes);\n\n  const plyMesh: PLYMesh = {\n    loader: 'ply',\n    loaderData: plyHeader,\n    header: {\n      vertexCount,\n      boundingBox\n    },\n    schema,\n    attributes,\n    indices: {value: new Uint32Array(0), size: 0},\n    mode,\n    topology\n  };\n\n  if (plyAttributes.indices.length > 0) {\n    plyMesh.indices = {value: new Uint32Array(plyAttributes.indices), size: 1};\n  }\n\n  return plyMesh;\n}\n\n/**\n * @param attributes\n * @returns accessors []\n */\n// eslint-disable-next-line complexity\nfunction getMeshAttributes(attributes: PLYAttributes): MeshAttributes {\n  const accessors: MeshAttributes = {};\n\n  for (const attributeName of Object.keys(attributes)) {\n    switch (attributeName) {\n      case 'vertices':\n        if (attributes.vertices.length > 0) {\n          accessors.POSITION = {value: new Float32Array(attributes.vertices), size: 3};\n        }\n        break;\n\n      // optional attributes data\n      case 'normals':\n        if (attributes.normals.length > 0) {\n          accessors.NORMAL = {value: new Float32Array(attributes.normals), size: 3};\n        }\n        break;\n\n      case 'uvs':\n        if (attributes.uvs.length > 0) {\n          accessors.TEXCOORD_0 = {value: new Float32Array(attributes.uvs), size: 2};\n        }\n        break;\n\n      case 'colors':\n        if (attributes.colors.length > 0) {\n          // TODO - normalized shoud be based on `uchar` flag in source data?\n          accessors.COLOR_0 = {value: new Uint8Array(attributes.colors), size: 3, normalized: true};\n        }\n        break;\n\n      case 'indices':\n        break;\n\n      default:\n        if (attributes[attributeName].length > 0) {\n          accessors[attributeName] = {value: new Float32Array(attributes[attributeName]), size: 1};\n        }\n        break;\n    }\n  }\n  return accessors;\n}\n"],"mappings":"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"}