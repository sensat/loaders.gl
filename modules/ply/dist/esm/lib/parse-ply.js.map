{"version":3,"file":"parse-ply.js","names":["normalizePLY","parsePLY","data","options","arguments","length","undefined","header","attributes","ArrayBuffer","text","TextDecoder","decode","parseHeader","format","parseASCII","parseBinary","PLY_HEADER_PATTERN","headerText","headerLength","result","exec","lines","split","parseHeaderLines","comments","elements","lineType","lineValues","currentElement","i","line","trim","shift","join","version","push","name","count","parseInt","properties","property","makePLYElementProperty","propertyNameMapping","console","log","getPLYAttributes","indices","vertices","normals","uvs","colors","element","propertyValues","type","countType","itemType","parseASCIINumber","n","parseFloat","Error","parsePLYElement","values","list","j","patternBody","body","currentElementCount","handleElement","buffer","elementName","propertyName","Object","keys","x","y","z","nx","ny","nz","s","t","red","green","blue","vertexIndices","vertex_indices","vertex_index","binaryRead","dataview","at","littleEndian","getInt8","getUint8","getInt16","getUint16","getInt32","getUint32","getFloat32","getFloat64","binaryReadElement","read","DataView","loc"],"sources":["../../../src/lib/parse-ply.ts"],"sourcesContent":["// PLY Loader, adapted from THREE.js (MIT license)\n//\n// Attributions per original THREE.js source file:\n//\n// @author Wei Meng / http://about.me/menway\n//\n// Description: A loader for PLY ASCII files (known as the Polygon File Format\n// or the Stanford Triangle Format).\n//\n// Limitations: ASCII decoding assumes file is UTF-8.\n//\n// If the PLY file uses non standard property names, they can be mapped while\n// loading. For example, the following maps the properties\n// “diffuse_(red|green|blue)” in the file to standard color names.\n//\n// parsePLY(data, {\n//   propertyNameMapping: {\n//     diffuse_red: 'red',\n//     diffuse_green: 'green',\n//     diffuse_blue: 'blue'\n//   }\n// });\nimport type {\n  PLYMesh,\n  PLYHeader,\n  PLYAttributes,\n  MeshHeader,\n  PLYElement,\n  PLYProperty\n} from './ply-types';\nimport normalizePLY from './normalize-ply';\n\nexport type ParsePLYOptions = {\n  propertyNameMapping?: Record<string, string>;\n};\n\n/**\n * @param data\n * @param options\n * @returns\n */\nexport function parsePLY(data: ArrayBuffer | string, options: ParsePLYOptions = {}): PLYMesh {\n  let header: PLYHeader & MeshHeader;\n  let attributes: PLYAttributes;\n\n  if (data instanceof ArrayBuffer) {\n    const text = new TextDecoder().decode(data);\n    header = parseHeader(text, options);\n    attributes = header.format === 'ascii' ? parseASCII(text, header) : parseBinary(data, header);\n  } else {\n    header = parseHeader(data, options);\n    attributes = parseASCII(data, header);\n  }\n\n  return normalizePLY(header, attributes);\n}\n\n/**\n * @param data\n * @param options\n * @returns header\n */\nfunction parseHeader(data: any, options?: ParsePLYOptions): PLYHeader {\n  const PLY_HEADER_PATTERN = /ply([\\s\\S]*)end_header\\s/;\n\n  let headerText = '';\n  let headerLength = 0;\n\n  const result = PLY_HEADER_PATTERN.exec(data);\n\n  if (result !== null) {\n    headerText = result[1];\n    headerLength = result[0].length;\n  }\n  const lines = headerText.split('\\n');\n  const header = parseHeaderLines(lines, headerLength, options);\n\n  return header;\n}\n\n/**\n * @param lines\n * @param headerLength\n * @param options\n * @returns header\n */\n// eslint-disable-next-line complexity\nfunction parseHeaderLines(\n  lines: string[],\n  headerLength: number,\n  options?: ParsePLYOptions\n): PLYHeader {\n  const header: PLYHeader = {\n    comments: [],\n    elements: [],\n    headerLength\n  };\n\n  let lineType: string | undefined;\n  let lineValues: string[];\n  let currentElement: PLYElement | null = null;\n\n  for (let i = 0; i < lines.length; i++) {\n    let line: string = lines[i];\n    line = line.trim();\n\n    if (line === '') {\n      // eslint-disable-next-line\n      continue;\n    }\n\n    lineValues = line.split(/\\s+/);\n    lineType = lineValues.shift();\n    line = lineValues.join(' ');\n\n    switch (lineType) {\n      case 'format':\n        header.format = lineValues[0];\n        header.version = lineValues[1];\n        break;\n\n      case 'comment':\n        header.comments.push(line);\n        break;\n\n      case 'element':\n        // Start new element, store previous element\n        if (currentElement) {\n          header.elements.push(currentElement);\n        }\n\n        currentElement = {\n          name: lineValues[0],\n          count: parseInt(lineValues[1], 10),\n          properties: []\n        };\n        break;\n\n      case 'property':\n        if (currentElement) {\n          const property = makePLYElementProperty(lineValues);\n          if (options?.propertyNameMapping && property.name in options?.propertyNameMapping) {\n            property.name = options?.propertyNameMapping[property.name];\n          }\n          currentElement.properties.push(property);\n        }\n        break;\n\n      default:\n        // eslint-disable-next-line\n        console.log('unhandled', lineType, lineValues);\n    }\n  }\n\n  // Store in-progress element\n  if (currentElement) {\n    header.elements.push(currentElement);\n  }\n\n  return header;\n}\n\n/** Generate attributes arrays from the header */\n// eslint-disable-next-line complexity\nfunction getPLYAttributes(header: PLYHeader): PLYAttributes {\n  // TODO Generate only the attribute arrays actually in the header\n  const attributes = {\n    indices: [],\n    vertices: [],\n    normals: [],\n    uvs: [],\n    colors: []\n  };\n\n  for (const element of header.elements) {\n    if (element.name === 'vertex') {\n      for (const property of element.properties) {\n        switch (property.name) {\n          case 'x':\n          case 'y':\n          case 'z':\n          case 'nx':\n          case 'ny':\n          case 'nz':\n          case 's':\n          case 't':\n          case 'red':\n          case 'green':\n          case 'blue':\n            break;\n          default:\n            // Add any non-geometry attributes\n            attributes[property.name] = [];\n            break;\n        }\n      }\n    }\n  }\n\n  return attributes;\n}\n\n/**\n * @param propertyValues\n * @returns property of ply element\n */\nfunction makePLYElementProperty(propertyValues: string[]): PLYProperty {\n  const type = propertyValues[0];\n  switch (type) {\n    case 'list':\n      return {\n        type,\n        name: propertyValues[3],\n        countType: propertyValues[1],\n        itemType: propertyValues[2]\n      };\n    default:\n      return {\n        type,\n        name: propertyValues[1]\n      };\n  }\n}\n\n/**\n * Parses ASCII number\n * @param n\n * @param type\n * @returns\n */\n// eslint-disable-next-line complexity\nfunction parseASCIINumber(n: string, type: string): number {\n  switch (type) {\n    case 'char':\n    case 'uchar':\n    case 'short':\n    case 'ushort':\n    case 'int':\n    case 'uint':\n    case 'int8':\n    case 'uint8':\n    case 'int16':\n    case 'uint16':\n    case 'int32':\n    case 'uint32':\n      return parseInt(n, 10);\n\n    case 'float':\n    case 'double':\n    case 'float32':\n    case 'float64':\n      return parseFloat(n);\n\n    default:\n      throw new Error(type);\n  }\n}\n\n/**\n * @param properties\n * @param line\n * @returns ASCII element\n */\nfunction parsePLYElement(properties: any[], line: string) {\n  const values: any = line.split(/\\s+/);\n\n  const element = {};\n\n  for (let i = 0; i < properties.length; i++) {\n    if (properties[i].type === 'list') {\n      const list: any = [];\n      const n = parseASCIINumber(values.shift(), properties[i].countType);\n\n      for (let j = 0; j < n; j++) {\n        list.push(parseASCIINumber(values.shift(), properties[i].itemType));\n      }\n\n      element[properties[i].name] = list;\n    } else {\n      element[properties[i].name] = parseASCIINumber(values.shift(), properties[i].type);\n    }\n  }\n\n  return element;\n}\n\n/**\n * @param data\n * @param header\n * @returns [attributes]\n */\nfunction parseASCII(data: any, header: PLYHeader): PLYAttributes {\n  // PLY ascii format specification, as per http://en.wikipedia.org/wiki/PLY_(file_format)\n\n  const attributes = getPLYAttributes(header);\n\n  let result: RegExpExecArray | null;\n\n  const patternBody = /end_header\\s([\\s\\S]*)$/;\n  let body = '';\n  if ((result = patternBody.exec(data)) !== null) {\n    body = result[1];\n  }\n\n  const lines = body.split('\\n');\n  let currentElement = 0;\n  let currentElementCount = 0;\n\n  for (let i = 0; i < lines.length; i++) {\n    let line = lines[i];\n    line = line.trim();\n\n    if (line !== '') {\n      if (currentElementCount >= header.elements[currentElement].count) {\n        currentElement++;\n        currentElementCount = 0;\n      }\n\n      const element = parsePLYElement(header.elements[currentElement].properties, line);\n      handleElement(attributes, header.elements[currentElement].name, element);\n      currentElementCount++;\n    }\n  }\n\n  return attributes;\n}\n\n/**\n * @param buffer\n * @param elementName\n * @param element\n */\n// eslint-disable-next-line complexity\nfunction handleElement(\n  buffer: {[index: string]: number[]},\n  elementName: string,\n  element: any = {}\n) {\n  if (elementName === 'vertex') {\n    for (const propertyName of Object.keys(element)) {\n      switch (propertyName) {\n        case 'x':\n          buffer.vertices.push(element.x, element.y, element.z);\n          break;\n        case 'y':\n        case 'z':\n          break;\n\n        case 'nx':\n          if ('nx' in element && 'ny' in element && 'nz' in element) {\n            buffer.normals.push(element.nx, element.ny, element.nz);\n          }\n          break;\n        case 'ny':\n        case 'nz':\n          break;\n\n        case 's':\n          if ('s' in element && 't' in element) {\n            buffer.uvs.push(element.s, element.t);\n          }\n          break;\n        case 't':\n          break;\n\n        case 'red':\n          if ('red' in element && 'green' in element && 'blue' in element) {\n            buffer.colors.push(element.red, element.green, element.blue);\n          }\n          break;\n        case 'green':\n        case 'blue':\n          break;\n\n        default:\n          buffer[propertyName].push(element[propertyName]);\n      }\n    }\n  } else if (elementName === 'face') {\n    const vertexIndices = element.vertex_indices || element.vertex_index; // issue #9338\n\n    if (vertexIndices.length === 3) {\n      buffer.indices.push(vertexIndices[0], vertexIndices[1], vertexIndices[2]);\n    } else if (vertexIndices.length === 4) {\n      buffer.indices.push(vertexIndices[0], vertexIndices[1], vertexIndices[3]);\n      buffer.indices.push(vertexIndices[1], vertexIndices[2], vertexIndices[3]);\n    }\n  }\n}\n\n/**\n * Reads binary data\n * @param dataview\n * @param at\n * @param type\n * @param littleEndian\n * @returns [number, number]\n */\n// eslint-disable-next-line complexity\nfunction binaryRead(dataview: DataView, at: number, type: any, littleEndian: boolean): number[] {\n  switch (type) {\n    // corespondences for non-specific length types here match rply:\n    case 'int8':\n    case 'char':\n      return [dataview.getInt8(at), 1];\n    case 'uint8':\n    case 'uchar':\n      return [dataview.getUint8(at), 1];\n    case 'int16':\n    case 'short':\n      return [dataview.getInt16(at, littleEndian), 2];\n    case 'uint16':\n    case 'ushort':\n      return [dataview.getUint16(at, littleEndian), 2];\n    case 'int32':\n    case 'int':\n      return [dataview.getInt32(at, littleEndian), 4];\n    case 'uint32':\n    case 'uint':\n      return [dataview.getUint32(at, littleEndian), 4];\n    case 'float32':\n    case 'float':\n      return [dataview.getFloat32(at, littleEndian), 4];\n    case 'float64':\n    case 'double':\n      return [dataview.getFloat64(at, littleEndian), 8];\n\n    default:\n      throw new Error(type);\n  }\n}\n\n/**\n * Reads binary data\n * @param dataview\n * @param at\n * @param properties\n * @param littleEndian\n * @returns [object, number]\n */\nfunction binaryReadElement(\n  dataview: DataView,\n  at: number,\n  properties: {[index: string]: any},\n  littleEndian: boolean\n): {}[] {\n  const element = {};\n  let result: number[];\n  let read = 0;\n\n  for (let i = 0; i < properties.length; i++) {\n    if (properties[i].type === 'list') {\n      const list = [];\n\n      result = binaryRead(dataview, at + read, properties[i].countType, littleEndian);\n      const n = result[0];\n      read += result[1];\n\n      for (let j = 0; j < n; j++) {\n        result = binaryRead(dataview, at + read, properties[i].itemType, littleEndian);\n        // @ts-ignore\n        list.push(result[0]);\n        read += result[1];\n      }\n\n      element[properties[i].name] = list;\n    } else {\n      result = binaryRead(dataview, at + read, properties[i].type, littleEndian);\n      element[properties[i].name] = result[0];\n      read += result[1];\n    }\n  }\n\n  return [element, read];\n}\n\ntype BinaryAttributes = {\n  [index: string]: number[];\n};\n\n/**\n * Parses binary data\n * @param data\n * @param header\n * @returns [attributes] of data\n */\nfunction parseBinary(data: ArrayBuffer, header: PLYHeader): BinaryAttributes {\n  const attributes = getPLYAttributes(header);\n\n  const littleEndian = header.format === 'binary_little_endian';\n  const body = new DataView(data, header.headerLength);\n  let result: any[];\n  let loc = 0;\n\n  for (let currentElement = 0; currentElement < header.elements.length; currentElement++) {\n    const count = header.elements[currentElement].count;\n    for (let currentElementCount = 0; currentElementCount < count; currentElementCount++) {\n      result = binaryReadElement(\n        body,\n        loc,\n        header.elements[currentElement].properties,\n        littleEndian\n      );\n      loc += result[1];\n      const element = result[0];\n\n      handleElement(attributes, header.elements[currentElement].name, element);\n    }\n  }\n\n  return attributes;\n}\n"],"mappings":"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"}