{"version":3,"file":"parse-shp-geometry.js","names":["LITTLE_ENDIAN","parseRecord","view","options","_ref","shp","_ref$_maxDimensions","_maxDimensions","offset","type","getInt32","Int32Array","BYTES_PER_ELEMENT","parseNull","parsePoint","Math","min","parsePoly","parseMultiPoint","Error","concat","dim","positions","_parsePositions","parsePositions","_parsePositions2","_slicedToArray2","default","value","size","Float64Array","nPoints","xyPositions","mPositions","zPositions","_parsePositions3","_parsePositions4","_parsePositions5","_parsePositions6","_parsePositions7","_parsePositions8","concatPositions","nParts","bufferOffset","byteOffset","bufferLength","ringIndices","set","buffer","slice","_parsePositions9","_parsePositions10","_parsePositions11","_parsePositions12","_parsePositions13","_parsePositions14","pathIndices","polygonIndices","i","length","startRingIndex","endRingIndex","ring","subarray","sign","getWindingDirection","push","primitivePolygonIndices","Uint32Array","arrayLength","nDim","getSignedArea","area","nCoords"],"sources":["../../../../src/lib/parsers/parse-shp-geometry.ts"],"sourcesContent":["import {BinaryGeometry, BinaryGeometryType} from '@loaders.gl/schema';\nimport {SHPLoaderOptions} from './types';\n\nconst LITTLE_ENDIAN = true;\n\n/**\n * Parse individual record\n *\n * @param view Record data\n * @return Binary Geometry Object\n */\n// eslint-disable-next-line complexity\nexport function parseRecord(view: DataView, options?: SHPLoaderOptions): BinaryGeometry | null {\n  const {_maxDimensions = 4} = options?.shp || {};\n\n  let offset = 0;\n  const type: number = view.getInt32(offset, LITTLE_ENDIAN);\n  offset += Int32Array.BYTES_PER_ELEMENT;\n\n  switch (type) {\n    case 0:\n      // Null Shape\n      return parseNull();\n    case 1:\n      // Point\n      return parsePoint(view, offset, Math.min(2, _maxDimensions));\n    case 3:\n      // PolyLine\n      return parsePoly(view, offset, Math.min(2, _maxDimensions), 'LineString');\n    case 5:\n      // Polygon\n      return parsePoly(view, offset, Math.min(2, _maxDimensions), 'Polygon');\n    case 8:\n      // MultiPoint\n      return parseMultiPoint(view, offset, Math.min(2, _maxDimensions));\n    // GeometryZ can have 3 or 4 dimensions, since the M is not required to\n    // exist\n    case 11:\n      // PointZ\n      return parsePoint(view, offset, Math.min(4, _maxDimensions));\n    case 13:\n      // PolyLineZ\n      return parsePoly(view, offset, Math.min(4, _maxDimensions), 'LineString');\n    case 15:\n      // PolygonZ\n      return parsePoly(view, offset, Math.min(4, _maxDimensions), 'Polygon');\n    case 18:\n      // MultiPointZ\n      return parseMultiPoint(view, offset, Math.min(4, _maxDimensions));\n    case 21:\n      // PointM\n      return parsePoint(view, offset, Math.min(3, _maxDimensions));\n    case 23:\n      // PolyLineM\n      return parsePoly(view, offset, Math.min(3, _maxDimensions), 'LineString');\n    case 25:\n      // PolygonM\n      return parsePoly(view, offset, Math.min(3, _maxDimensions), 'Polygon');\n    case 28:\n      // MultiPointM\n      return parseMultiPoint(view, offset, Math.min(3, _maxDimensions));\n    default:\n      throw new Error(`unsupported shape type: ${type}`);\n  }\n}\n\n// TODO handle null\n/**\n * Parse Null geometry\n *\n * @return null\n */\nfunction parseNull(): null {\n  return null;\n}\n\n/**\n * Parse point geometry\n *\n * @param view Geometry data\n * @param offset Offset in view\n * @param dim Dimension size\n */\nfunction parsePoint(view: DataView, offset: number, dim: number): BinaryGeometry {\n  let positions: Float64Array;\n  [positions, offset] = parsePositions(view, offset, 1, dim);\n\n  return {\n    positions: {value: positions, size: dim},\n    type: 'Point'\n  };\n}\n\n/**\n * Parse MultiPoint geometry\n *\n * @param view Geometry data\n * @param offset Offset in view\n * @param dim Input dimension\n * @return Binary geometry object\n */\nfunction parseMultiPoint(view: DataView, offset: number, dim: number): BinaryGeometry {\n  // skip parsing box\n  offset += 4 * Float64Array.BYTES_PER_ELEMENT;\n\n  const nPoints = view.getInt32(offset, LITTLE_ENDIAN);\n  offset += Int32Array.BYTES_PER_ELEMENT;\n\n  let xyPositions: Float64Array | null = null;\n  let mPositions: Float64Array | null = null;\n  let zPositions: Float64Array | null = null;\n  [xyPositions, offset] = parsePositions(view, offset, nPoints, 2);\n\n  // Parse Z coordinates\n  if (dim === 4) {\n    // skip parsing range\n    offset += 2 * Float64Array.BYTES_PER_ELEMENT;\n    [zPositions, offset] = parsePositions(view, offset, nPoints, 1);\n  }\n\n  // Parse M coordinates\n  if (dim >= 3) {\n    // skip parsing range\n    offset += 2 * Float64Array.BYTES_PER_ELEMENT;\n    [mPositions, offset] = parsePositions(view, offset, nPoints, 1);\n  }\n\n  const positions = concatPositions(xyPositions, mPositions, zPositions);\n\n  return {\n    positions: {value: positions, size: dim},\n    type: 'Point'\n  };\n}\n\n/**\n * Polygon and PolyLine parsing\n *\n * @param view Geometry data\n * @param offset Offset in view\n * @param dim Input dimension\n * @param type Either 'Polygon' or 'Polyline'\n * @return Binary geometry object\n */\n// eslint-disable-next-line max-statements\nfunction parsePoly(\n  view: DataView,\n  offset: number,\n  dim: number,\n  type: BinaryGeometryType\n): BinaryGeometry {\n  // skip parsing bounding box\n  offset += 4 * Float64Array.BYTES_PER_ELEMENT;\n\n  const nParts = view.getInt32(offset, LITTLE_ENDIAN);\n  offset += Int32Array.BYTES_PER_ELEMENT;\n  const nPoints = view.getInt32(offset, LITTLE_ENDIAN);\n  offset += Int32Array.BYTES_PER_ELEMENT;\n\n  // Create longer indices array by 1 because output format is expected to\n  // include the last index as the total number of positions\n  const bufferOffset = view.byteOffset + offset;\n  const bufferLength = nParts * Int32Array.BYTES_PER_ELEMENT;\n  const ringIndices = new Int32Array(nParts + 1);\n  ringIndices.set(new Int32Array(view.buffer.slice(bufferOffset, bufferOffset + bufferLength)));\n  ringIndices[nParts] = nPoints;\n  offset += nParts * Int32Array.BYTES_PER_ELEMENT;\n\n  let xyPositions: Float64Array | null = null;\n  let mPositions: Float64Array | null = null;\n  let zPositions: Float64Array | null = null;\n  [xyPositions, offset] = parsePositions(view, offset, nPoints, 2);\n\n  // Parse Z coordinates\n  if (dim === 4) {\n    // skip parsing range\n    offset += 2 * Float64Array.BYTES_PER_ELEMENT;\n    [zPositions, offset] = parsePositions(view, offset, nPoints, 1);\n  }\n\n  // Parse M coordinates\n  if (dim >= 3) {\n    // skip parsing range\n    offset += 2 * Float64Array.BYTES_PER_ELEMENT;\n    [mPositions, offset] = parsePositions(view, offset, nPoints, 1);\n  }\n\n  const positions = concatPositions(xyPositions, mPositions, zPositions);\n\n  // parsePoly only accepts type = LineString or Polygon\n  if (type === 'LineString') {\n    return {\n      type,\n      positions: {value: positions, size: dim},\n      pathIndices: {value: ringIndices, size: 1}\n    };\n  }\n\n  // for every ring, determine sign of polygon\n  // Use only 2D positions for ring calc\n  const polygonIndices: number[] = [];\n  for (let i = 1; i < ringIndices.length; i++) {\n    const startRingIndex = ringIndices[i - 1];\n    const endRingIndex = ringIndices[i];\n    // @ts-ignore\n    const ring = xyPositions.subarray(startRingIndex * 2, endRingIndex * 2);\n    const sign = getWindingDirection(ring);\n\n    // A positive sign implies clockwise\n    // A clockwise ring is a filled ring\n    if (sign > 0) {\n      polygonIndices.push(startRingIndex);\n    }\n  }\n\n  polygonIndices.push(nPoints);\n\n  return {\n    type,\n    positions: {value: positions, size: dim},\n    primitivePolygonIndices: {value: ringIndices, size: 1},\n    // TODO: Dynamically choose Uint32Array over Uint16Array only when\n    // necessary. I believe the implementation requires nPoints to be the\n    // largest value in the array, so you should be able to use Uint32Array only\n    // when nPoints > 65535.\n    polygonIndices: {value: new Uint32Array(polygonIndices), size: 1}\n  };\n}\n\n/**\n * Parse a contiguous block of positions into a Float64Array\n *\n * @param view  Geometry data\n * @param offset  Offset in view\n * @param nPoints Number of points\n * @param dim     Input dimension\n * @return Data and offset\n */\nfunction parsePositions(\n  view: DataView,\n  offset: number,\n  nPoints: number,\n  dim: number\n): [Float64Array, number] {\n  const bufferOffset = view.byteOffset + offset;\n  const bufferLength = nPoints * dim * Float64Array.BYTES_PER_ELEMENT;\n  return [\n    new Float64Array(view.buffer.slice(bufferOffset, bufferOffset + bufferLength)),\n    offset + bufferLength\n  ];\n}\n\n/**\n * Concatenate and interleave positions arrays\n * xy positions are interleaved; mPositions, zPositions are their own arrays\n *\n * @param xyPositions 2d positions\n * @param mPositions  M positions\n * @param zPositions  Z positions\n * @return Combined interleaved positions\n */\n// eslint-disable-next-line complexity\nfunction concatPositions(\n  xyPositions: Float64Array,\n  mPositions: Float64Array | null,\n  zPositions: Float64Array | null\n): Float64Array {\n  if (!(mPositions || zPositions)) {\n    return xyPositions;\n  }\n\n  let arrayLength = xyPositions.length;\n  let nDim = 2;\n\n  if (zPositions && zPositions.length) {\n    arrayLength += zPositions.length;\n    nDim++;\n  }\n\n  if (mPositions && mPositions.length) {\n    arrayLength += mPositions.length;\n    nDim++;\n  }\n\n  const positions = new Float64Array(arrayLength);\n  for (let i = 0; i < xyPositions.length / 2; i++) {\n    positions[nDim * i] = xyPositions[i * 2];\n    positions[nDim * i + 1] = xyPositions[i * 2 + 1];\n  }\n\n  if (zPositions && zPositions.length) {\n    for (let i = 0; i < zPositions.length; i++) {\n      // If Z coordinates exist; used as third coord in positions array\n      positions[nDim * i + 2] = zPositions[i];\n    }\n  }\n\n  if (mPositions && mPositions.length) {\n    for (let i = 0; i < mPositions.length; i++) {\n      // M is always last, either 3rd or 4th depending on if Z exists\n      positions[nDim * i + (nDim - 1)] = mPositions[i];\n    }\n  }\n\n  return positions;\n}\n\n/**\n * Returns the direction of the polygon path\n * A positive number is clockwise.\n * A negative number is counter clockwise.\n *\n * @param positions\n * @return Sign of polygon ring\n */\nfunction getWindingDirection(positions: Float64Array): number {\n  return Math.sign(getSignedArea(positions));\n}\n\n/**\n * Get signed area of flat typed array of 2d positions\n *\n * @param positions\n * @return Signed area of polygon ring\n */\nfunction getSignedArea(positions: Float64Array): number {\n  let area = 0;\n\n  // Rings are closed according to shapefile spec\n  const nCoords = positions.length / 2 - 1;\n  for (let i = 0; i < nCoords; i++) {\n    area +=\n      (positions[i * 2] + positions[(i + 1) * 2]) *\n      (positions[i * 2 + 1] - positions[(i + 1) * 2 + 1]);\n  }\n\n  return area / 2;\n}\n"],"mappings":";;;;;;;;AAGA,IAAMA,aAAa,GAAG,IAAI;AASnB,SAASC,WAAWA,CAACC,IAAc,EAAEC,OAA0B,EAAyB;EAC7F,IAAAC,IAAA,GAA6B,CAAAD,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEE,GAAG,KAAI,CAAC,CAAC;IAAAC,mBAAA,GAAAF,IAAA,CAAxCG,cAAc;IAAdA,cAAc,GAAAD,mBAAA,cAAG,CAAC,GAAAA,mBAAA;EAEzB,IAAIE,MAAM,GAAG,CAAC;EACd,IAAMC,IAAY,GAAGP,IAAI,CAACQ,QAAQ,CAACF,MAAM,EAAER,aAAa,CAAC;EACzDQ,MAAM,IAAIG,UAAU,CAACC,iBAAiB;EAEtC,QAAQH,IAAI;IACV,KAAK,CAAC;MAEJ,OAAOI,SAAS,CAAC,CAAC;IACpB,KAAK,CAAC;MAEJ,OAAOC,UAAU,CAACZ,IAAI,EAAEM,MAAM,EAAEO,IAAI,CAACC,GAAG,CAAC,CAAC,EAAET,cAAc,CAAC,CAAC;IAC9D,KAAK,CAAC;MAEJ,OAAOU,SAAS,CAACf,IAAI,EAAEM,MAAM,EAAEO,IAAI,CAACC,GAAG,CAAC,CAAC,EAAET,cAAc,CAAC,EAAE,YAAY,CAAC;IAC3E,KAAK,CAAC;MAEJ,OAAOU,SAAS,CAACf,IAAI,EAAEM,MAAM,EAAEO,IAAI,CAACC,GAAG,CAAC,CAAC,EAAET,cAAc,CAAC,EAAE,SAAS,CAAC;IACxE,KAAK,CAAC;MAEJ,OAAOW,eAAe,CAAChB,IAAI,EAAEM,MAAM,EAAEO,IAAI,CAACC,GAAG,CAAC,CAAC,EAAET,cAAc,CAAC,CAAC;IAGnE,KAAK,EAAE;MAEL,OAAOO,UAAU,CAACZ,IAAI,EAAEM,MAAM,EAAEO,IAAI,CAACC,GAAG,CAAC,CAAC,EAAET,cAAc,CAAC,CAAC;IAC9D,KAAK,EAAE;MAEL,OAAOU,SAAS,CAACf,IAAI,EAAEM,MAAM,EAAEO,IAAI,CAACC,GAAG,CAAC,CAAC,EAAET,cAAc,CAAC,EAAE,YAAY,CAAC;IAC3E,KAAK,EAAE;MAEL,OAAOU,SAAS,CAACf,IAAI,EAAEM,MAAM,EAAEO,IAAI,CAACC,GAAG,CAAC,CAAC,EAAET,cAAc,CAAC,EAAE,SAAS,CAAC;IACxE,KAAK,EAAE;MAEL,OAAOW,eAAe,CAAChB,IAAI,EAAEM,MAAM,EAAEO,IAAI,CAACC,GAAG,CAAC,CAAC,EAAET,cAAc,CAAC,CAAC;IACnE,KAAK,EAAE;MAEL,OAAOO,UAAU,CAACZ,IAAI,EAAEM,MAAM,EAAEO,IAAI,CAACC,GAAG,CAAC,CAAC,EAAET,cAAc,CAAC,CAAC;IAC9D,KAAK,EAAE;MAEL,OAAOU,SAAS,CAACf,IAAI,EAAEM,MAAM,EAAEO,IAAI,CAACC,GAAG,CAAC,CAAC,EAAET,cAAc,CAAC,EAAE,YAAY,CAAC;IAC3E,KAAK,EAAE;MAEL,OAAOU,SAAS,CAACf,IAAI,EAAEM,MAAM,EAAEO,IAAI,CAACC,GAAG,CAAC,CAAC,EAAET,cAAc,CAAC,EAAE,SAAS,CAAC;IACxE,KAAK,EAAE;MAEL,OAAOW,eAAe,CAAChB,IAAI,EAAEM,MAAM,EAAEO,IAAI,CAACC,GAAG,CAAC,CAAC,EAAET,cAAc,CAAC,CAAC;IACnE;MACE,MAAM,IAAIY,KAAK,4BAAAC,MAAA,CAA4BX,IAAI,CAAE,CAAC;EACtD;AACF;AAQA,SAASI,SAASA,CAAA,EAAS;EACzB,OAAO,IAAI;AACb;AASA,SAASC,UAAUA,CAACZ,IAAc,EAAEM,MAAc,EAAEa,GAAW,EAAkB;EAC/E,IAAIC,SAAuB;EAAC,IAAAC,eAAA,GACNC,cAAc,CAACtB,IAAI,EAAEM,MAAM,EAAE,CAAC,EAAEa,GAAG,CAAC;EAAA,IAAAI,gBAAA,OAAAC,eAAA,CAAAC,OAAA,EAAAJ,eAAA;EAAzDD,SAAS,GAAAG,gBAAA;EAAEjB,MAAM,GAAAiB,gBAAA;EAElB,OAAO;IACLH,SAAS,EAAE;MAACM,KAAK,EAAEN,SAAS;MAAEO,IAAI,EAAER;IAAG,CAAC;IACxCZ,IAAI,EAAE;EACR,CAAC;AACH;AAUA,SAASS,eAAeA,CAAChB,IAAc,EAAEM,MAAc,EAAEa,GAAW,EAAkB;EAEpFb,MAAM,IAAI,CAAC,GAAGsB,YAAY,CAAClB,iBAAiB;EAE5C,IAAMmB,OAAO,GAAG7B,IAAI,CAACQ,QAAQ,CAACF,MAAM,EAAER,aAAa,CAAC;EACpDQ,MAAM,IAAIG,UAAU,CAACC,iBAAiB;EAEtC,IAAIoB,WAAgC,GAAG,IAAI;EAC3C,IAAIC,UAA+B,GAAG,IAAI;EAC1C,IAAIC,UAA+B,GAAG,IAAI;EAAC,IAAAC,gBAAA,GACnBX,cAAc,CAACtB,IAAI,EAAEM,MAAM,EAAEuB,OAAO,EAAE,CAAC,CAAC;EAAA,IAAAK,gBAAA,OAAAV,eAAA,CAAAC,OAAA,EAAAQ,gBAAA;EAA/DH,WAAW,GAAAI,gBAAA;EAAE5B,MAAM,GAAA4B,gBAAA;EAGpB,IAAIf,GAAG,KAAK,CAAC,EAAE;IAEbb,MAAM,IAAI,CAAC,GAAGsB,YAAY,CAAClB,iBAAiB;IAAC,IAAAyB,gBAAA,GACtBb,cAAc,CAACtB,IAAI,EAAEM,MAAM,EAAEuB,OAAO,EAAE,CAAC,CAAC;IAAA,IAAAO,gBAAA,OAAAZ,eAAA,CAAAC,OAAA,EAAAU,gBAAA;IAA9DH,UAAU,GAAAI,gBAAA;IAAE9B,MAAM,GAAA8B,gBAAA;EACrB;EAGA,IAAIjB,GAAG,IAAI,CAAC,EAAE;IAEZb,MAAM,IAAI,CAAC,GAAGsB,YAAY,CAAClB,iBAAiB;IAAC,IAAA2B,gBAAA,GACtBf,cAAc,CAACtB,IAAI,EAAEM,MAAM,EAAEuB,OAAO,EAAE,CAAC,CAAC;IAAA,IAAAS,gBAAA,OAAAd,eAAA,CAAAC,OAAA,EAAAY,gBAAA;IAA9DN,UAAU,GAAAO,gBAAA;IAAEhC,MAAM,GAAAgC,gBAAA;EACrB;EAEA,IAAMlB,SAAS,GAAGmB,eAAe,CAACT,WAAW,EAAEC,UAAU,EAAEC,UAAU,CAAC;EAEtE,OAAO;IACLZ,SAAS,EAAE;MAACM,KAAK,EAAEN,SAAS;MAAEO,IAAI,EAAER;IAAG,CAAC;IACxCZ,IAAI,EAAE;EACR,CAAC;AACH;AAYA,SAASQ,SAASA,CAChBf,IAAc,EACdM,MAAc,EACda,GAAW,EACXZ,IAAwB,EACR;EAEhBD,MAAM,IAAI,CAAC,GAAGsB,YAAY,CAAClB,iBAAiB;EAE5C,IAAM8B,MAAM,GAAGxC,IAAI,CAACQ,QAAQ,CAACF,MAAM,EAAER,aAAa,CAAC;EACnDQ,MAAM,IAAIG,UAAU,CAACC,iBAAiB;EACtC,IAAMmB,OAAO,GAAG7B,IAAI,CAACQ,QAAQ,CAACF,MAAM,EAAER,aAAa,CAAC;EACpDQ,MAAM,IAAIG,UAAU,CAACC,iBAAiB;EAItC,IAAM+B,YAAY,GAAGzC,IAAI,CAAC0C,UAAU,GAAGpC,MAAM;EAC7C,IAAMqC,YAAY,GAAGH,MAAM,GAAG/B,UAAU,CAACC,iBAAiB;EAC1D,IAAMkC,WAAW,GAAG,IAAInC,UAAU,CAAC+B,MAAM,GAAG,CAAC,CAAC;EAC9CI,WAAW,CAACC,GAAG,CAAC,IAAIpC,UAAU,CAACT,IAAI,CAAC8C,MAAM,CAACC,KAAK,CAACN,YAAY,EAAEA,YAAY,GAAGE,YAAY,CAAC,CAAC,CAAC;EAC7FC,WAAW,CAACJ,MAAM,CAAC,GAAGX,OAAO;EAC7BvB,MAAM,IAAIkC,MAAM,GAAG/B,UAAU,CAACC,iBAAiB;EAE/C,IAAIoB,WAAgC,GAAG,IAAI;EAC3C,IAAIC,UAA+B,GAAG,IAAI;EAC1C,IAAIC,UAA+B,GAAG,IAAI;EAAC,IAAAgB,gBAAA,GACnB1B,cAAc,CAACtB,IAAI,EAAEM,MAAM,EAAEuB,OAAO,EAAE,CAAC,CAAC;EAAA,IAAAoB,iBAAA,OAAAzB,eAAA,CAAAC,OAAA,EAAAuB,gBAAA;EAA/DlB,WAAW,GAAAmB,iBAAA;EAAE3C,MAAM,GAAA2C,iBAAA;EAGpB,IAAI9B,GAAG,KAAK,CAAC,EAAE;IAEbb,MAAM,IAAI,CAAC,GAAGsB,YAAY,CAAClB,iBAAiB;IAAC,IAAAwC,iBAAA,GACtB5B,cAAc,CAACtB,IAAI,EAAEM,MAAM,EAAEuB,OAAO,EAAE,CAAC,CAAC;IAAA,IAAAsB,iBAAA,OAAA3B,eAAA,CAAAC,OAAA,EAAAyB,iBAAA;IAA9DlB,UAAU,GAAAmB,iBAAA;IAAE7C,MAAM,GAAA6C,iBAAA;EACrB;EAGA,IAAIhC,GAAG,IAAI,CAAC,EAAE;IAEZb,MAAM,IAAI,CAAC,GAAGsB,YAAY,CAAClB,iBAAiB;IAAC,IAAA0C,iBAAA,GACtB9B,cAAc,CAACtB,IAAI,EAAEM,MAAM,EAAEuB,OAAO,EAAE,CAAC,CAAC;IAAA,IAAAwB,iBAAA,OAAA7B,eAAA,CAAAC,OAAA,EAAA2B,iBAAA;IAA9DrB,UAAU,GAAAsB,iBAAA;IAAE/C,MAAM,GAAA+C,iBAAA;EACrB;EAEA,IAAMjC,SAAS,GAAGmB,eAAe,CAACT,WAAW,EAAEC,UAAU,EAAEC,UAAU,CAAC;EAGtE,IAAIzB,IAAI,KAAK,YAAY,EAAE;IACzB,OAAO;MACLA,IAAI,EAAJA,IAAI;MACJa,SAAS,EAAE;QAACM,KAAK,EAAEN,SAAS;QAAEO,IAAI,EAAER;MAAG,CAAC;MACxCmC,WAAW,EAAE;QAAC5B,KAAK,EAAEkB,WAAW;QAAEjB,IAAI,EAAE;MAAC;IAC3C,CAAC;EACH;EAIA,IAAM4B,cAAwB,GAAG,EAAE;EACnC,KAAK,IAAIC,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGZ,WAAW,CAACa,MAAM,EAAED,CAAC,EAAE,EAAE;IAC3C,IAAME,cAAc,GAAGd,WAAW,CAACY,CAAC,GAAG,CAAC,CAAC;IACzC,IAAMG,YAAY,GAAGf,WAAW,CAACY,CAAC,CAAC;IAEnC,IAAMI,IAAI,GAAG9B,WAAW,CAAC+B,QAAQ,CAACH,cAAc,GAAG,CAAC,EAAEC,YAAY,GAAG,CAAC,CAAC;IACvE,IAAMG,IAAI,GAAGC,mBAAmB,CAACH,IAAI,CAAC;IAItC,IAAIE,IAAI,GAAG,CAAC,EAAE;MACZP,cAAc,CAACS,IAAI,CAACN,cAAc,CAAC;IACrC;EACF;EAEAH,cAAc,CAACS,IAAI,CAACnC,OAAO,CAAC;EAE5B,OAAO;IACLtB,IAAI,EAAJA,IAAI;IACJa,SAAS,EAAE;MAACM,KAAK,EAAEN,SAAS;MAAEO,IAAI,EAAER;IAAG,CAAC;IACxC8C,uBAAuB,EAAE;MAACvC,KAAK,EAAEkB,WAAW;MAAEjB,IAAI,EAAE;IAAC,CAAC;IAKtD4B,cAAc,EAAE;MAAC7B,KAAK,EAAE,IAAIwC,WAAW,CAACX,cAAc,CAAC;MAAE5B,IAAI,EAAE;IAAC;EAClE,CAAC;AACH;AAWA,SAASL,cAAcA,CACrBtB,IAAc,EACdM,MAAc,EACduB,OAAe,EACfV,GAAW,EACa;EACxB,IAAMsB,YAAY,GAAGzC,IAAI,CAAC0C,UAAU,GAAGpC,MAAM;EAC7C,IAAMqC,YAAY,GAAGd,OAAO,GAAGV,GAAG,GAAGS,YAAY,CAAClB,iBAAiB;EACnE,OAAO,CACL,IAAIkB,YAAY,CAAC5B,IAAI,CAAC8C,MAAM,CAACC,KAAK,CAACN,YAAY,EAAEA,YAAY,GAAGE,YAAY,CAAC,CAAC,EAC9ErC,MAAM,GAAGqC,YAAY,CACtB;AACH;AAYA,SAASJ,eAAeA,CACtBT,WAAyB,EACzBC,UAA+B,EAC/BC,UAA+B,EACjB;EACd,IAAI,EAAED,UAAU,IAAIC,UAAU,CAAC,EAAE;IAC/B,OAAOF,WAAW;EACpB;EAEA,IAAIqC,WAAW,GAAGrC,WAAW,CAAC2B,MAAM;EACpC,IAAIW,IAAI,GAAG,CAAC;EAEZ,IAAIpC,UAAU,IAAIA,UAAU,CAACyB,MAAM,EAAE;IACnCU,WAAW,IAAInC,UAAU,CAACyB,MAAM;IAChCW,IAAI,EAAE;EACR;EAEA,IAAIrC,UAAU,IAAIA,UAAU,CAAC0B,MAAM,EAAE;IACnCU,WAAW,IAAIpC,UAAU,CAAC0B,MAAM;IAChCW,IAAI,EAAE;EACR;EAEA,IAAMhD,SAAS,GAAG,IAAIQ,YAAY,CAACuC,WAAW,CAAC;EAC/C,KAAK,IAAIX,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAG1B,WAAW,CAAC2B,MAAM,GAAG,CAAC,EAAED,CAAC,EAAE,EAAE;IAC/CpC,SAAS,CAACgD,IAAI,GAAGZ,CAAC,CAAC,GAAG1B,WAAW,CAAC0B,CAAC,GAAG,CAAC,CAAC;IACxCpC,SAAS,CAACgD,IAAI,GAAGZ,CAAC,GAAG,CAAC,CAAC,GAAG1B,WAAW,CAAC0B,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;EAClD;EAEA,IAAIxB,UAAU,IAAIA,UAAU,CAACyB,MAAM,EAAE;IACnC,KAAK,IAAID,EAAC,GAAG,CAAC,EAAEA,EAAC,GAAGxB,UAAU,CAACyB,MAAM,EAAED,EAAC,EAAE,EAAE;MAE1CpC,SAAS,CAACgD,IAAI,GAAGZ,EAAC,GAAG,CAAC,CAAC,GAAGxB,UAAU,CAACwB,EAAC,CAAC;IACzC;EACF;EAEA,IAAIzB,UAAU,IAAIA,UAAU,CAAC0B,MAAM,EAAE;IACnC,KAAK,IAAID,GAAC,GAAG,CAAC,EAAEA,GAAC,GAAGzB,UAAU,CAAC0B,MAAM,EAAED,GAAC,EAAE,EAAE;MAE1CpC,SAAS,CAACgD,IAAI,GAAGZ,GAAC,IAAIY,IAAI,GAAG,CAAC,CAAC,CAAC,GAAGrC,UAAU,CAACyB,GAAC,CAAC;IAClD;EACF;EAEA,OAAOpC,SAAS;AAClB;AAUA,SAAS2C,mBAAmBA,CAAC3C,SAAuB,EAAU;EAC5D,OAAOP,IAAI,CAACiD,IAAI,CAACO,aAAa,CAACjD,SAAS,CAAC,CAAC;AAC5C;AAQA,SAASiD,aAAaA,CAACjD,SAAuB,EAAU;EACtD,IAAIkD,IAAI,GAAG,CAAC;EAGZ,IAAMC,OAAO,GAAGnD,SAAS,CAACqC,MAAM,GAAG,CAAC,GAAG,CAAC;EACxC,KAAK,IAAID,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGe,OAAO,EAAEf,CAAC,EAAE,EAAE;IAChCc,IAAI,IACF,CAAClD,SAAS,CAACoC,CAAC,GAAG,CAAC,CAAC,GAAGpC,SAAS,CAAC,CAACoC,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,KACzCpC,SAAS,CAACoC,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,GAAGpC,SAAS,CAAC,CAACoC,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC;EACvD;EAEA,OAAOc,IAAI,GAAG,CAAC;AACjB"}