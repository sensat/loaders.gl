{"version":3,"file":"parse-glb.js","names":["_loaderUtils","require","LITTLE_ENDIAN","MAGIC_glTF","GLB_FILE_HEADER_SIZE","GLB_CHUNK_HEADER_SIZE","GLB_CHUNK_TYPE_JSON","GLB_CHUNK_TYPE_BIN","GLB_V1_CONTENT_FORMAT_JSON","GLB_CHUNK_TYPE_JSON_XVIZ_DEPRECATED","GLB_CHUNK_TYPE_BIX_XVIZ_DEPRECATED","getMagicString","dataView","byteOffset","arguments","length","undefined","concat","String","fromCharCode","getUint8","isGLB","arrayBuffer","options","DataView","_options$magic","magic","magic1","getUint32","parseGLBSync","glb","type","version","byteLength","Object","assign","header","hasBinChunk","json","binChunks","parseGLBV1","parseGLBV2","Error","assert","contentLength","contentFormat","parseJSONChunk","parseBINChunk","parseGLBChunksSync","chunkLength","chunkFormat","strict","padToNBytes","jsonChunk","Uint8Array","buffer","textDecoder","TextDecoder","jsonText","decode","JSON","parse","push"],"sources":["../../../../src/lib/parsers/parse-glb.ts"],"sourcesContent":["/* eslint-disable camelcase, max-statements */\n// https://github.com/KhronosGroup/glTF/tree/master/specification/2.0#glb-file-format-specification\n// https://github.com/KhronosGroup/glTF/tree/master/extensions/1.0/Khronos/KHR_binary_glTF\nimport type {GLB} from '../types/glb-types';\nimport {padToNBytes, assert} from '@loaders.gl/loader-utils';\n\n/** Options for parsing a GLB */\nexport type ParseGLBOptions = {\n  /** @deprecated This option was used by XVIZ protocol to define a non-standard magic number */\n  magic?: number;\n  /** @deprecated This option was used by XVIZ protocol to embed non-standard chunks */\n  strict?: boolean;\n};\n\n/** Binary GLTF is little endian. */\nconst LITTLE_ENDIAN = true;\n\n/** 'glTF' in Big-Endian ASCII */\nconst MAGIC_glTF = 0x676c5446;\nconst GLB_FILE_HEADER_SIZE = 12;\nconst GLB_CHUNK_HEADER_SIZE = 8;\nconst GLB_CHUNK_TYPE_JSON = 0x4e4f534a;\nconst GLB_CHUNK_TYPE_BIN = 0x004e4942;\nconst GLB_V1_CONTENT_FORMAT_JSON = 0x0;\n\n/** @deprecated - Backward compatibility for old xviz files */\nconst GLB_CHUNK_TYPE_JSON_XVIZ_DEPRECATED = 0;\n/** @deprecated - Backward compatibility for old xviz files */\nconst GLB_CHUNK_TYPE_BIX_XVIZ_DEPRECATED = 1;\n\nfunction getMagicString(dataView, byteOffset = 0) {\n  return `\\\n${String.fromCharCode(dataView.getUint8(byteOffset + 0))}\\\n${String.fromCharCode(dataView.getUint8(byteOffset + 1))}\\\n${String.fromCharCode(dataView.getUint8(byteOffset + 2))}\\\n${String.fromCharCode(dataView.getUint8(byteOffset + 3))}`;\n}\n\n/** Check if the contents of an array buffer contains GLB byte markers */\nexport function isGLB(\n  arrayBuffer: ArrayBuffer,\n  byteOffset: number = 0,\n  options: ParseGLBOptions = {}\n): boolean {\n  const dataView = new DataView(arrayBuffer);\n  // Check that GLB Header starts with the magic number\n  const {magic = MAGIC_glTF} = options;\n  const magic1 = dataView.getUint32(byteOffset, false);\n  return magic1 === magic || magic1 === MAGIC_glTF;\n}\n\n/**\n * Synchronously parse a GLB\n * @param glb - Target, Output is stored there\n * @param arrayBuffer - Input data\n * @param byteOffset - Offset into arrayBuffer to start parsing from (for \"embedded\" GLBs, e.g. in 3D tiles)\n * @param options\n * @returns\n */\nexport function parseGLBSync(\n  glb: GLB,\n  arrayBuffer: ArrayBuffer,\n  byteOffset: number = 0,\n  options: ParseGLBOptions = {}\n) {\n  // Check that GLB Header starts with the magic number\n  const dataView = new DataView(arrayBuffer);\n\n  // Compare format with GLBLoader documentation\n  const type = getMagicString(dataView, byteOffset + 0);\n  const version = dataView.getUint32(byteOffset + 4, LITTLE_ENDIAN); // Version 2 of binary glTF container format\n  const byteLength = dataView.getUint32(byteOffset + 8, LITTLE_ENDIAN); // Total byte length of binary file\n\n  Object.assign(glb, {\n    // Put less important stuff in a header, to avoid clutter\n    header: {\n      byteOffset, // Byte offset into the initial arrayBuffer\n      byteLength,\n      hasBinChunk: false\n    },\n\n    type,\n    version,\n\n    json: {},\n    binChunks: []\n  } as GLB);\n\n  byteOffset += GLB_FILE_HEADER_SIZE;\n\n  switch (glb.version) {\n    case 1:\n      return parseGLBV1(glb, dataView, byteOffset);\n    case 2:\n      return parseGLBV2(glb, dataView, byteOffset, (options = {}));\n    default:\n      throw new Error(`Invalid GLB version ${glb.version}. Only supports version 1 and 2.`);\n  }\n}\n\n/**\n * Parse a V1 GLB\n * @param glb - target, output is stored in this object\n * @param dataView - Input, memory to be parsed\n * @param byteOffset - Offset of first byte of GLB data in the data view\n * @returns Number of bytes parsed (there could be additional non-GLB data after the GLB)\n */\nfunction parseGLBV1(glb: GLB, dataView: DataView, byteOffset: number): number {\n  // Sanity: ensure file is big enough to hold at least the headers\n  assert(glb.header.byteLength > GLB_FILE_HEADER_SIZE + GLB_CHUNK_HEADER_SIZE);\n\n  // Explanation of GLB structure:\n  // https://cloud.githubusercontent.com/assets/3479527/22600725/36b87122-ea55-11e6-9d40-6fd42819fcab.png\n  const contentLength = dataView.getUint32(byteOffset + 0, LITTLE_ENDIAN); // Byte length of chunk\n  const contentFormat = dataView.getUint32(byteOffset + 4, LITTLE_ENDIAN); // Chunk format as uint32\n  byteOffset += GLB_CHUNK_HEADER_SIZE;\n\n  // GLB v1 only supports a single chunk type\n  assert(contentFormat === GLB_V1_CONTENT_FORMAT_JSON);\n\n  parseJSONChunk(glb, dataView, byteOffset, contentLength);\n  // No need to call the function padToBytes() from parseJSONChunk()\n  byteOffset += contentLength;\n  byteOffset += parseBINChunk(glb, dataView, byteOffset, glb.header.byteLength);\n\n  return byteOffset;\n}\n\n/**\n * Parse a V2 GLB\n * @param glb - target, output is stored in this object\n * @param dataView - Input, memory to be parsed\n * @param byteOffset - Offset of first byte of GLB data in the data view\n * @returns Number of bytes parsed (there could be additional non-GLB data after the GLB)\n */\nfunction parseGLBV2(\n  glb: GLB,\n  dataView: DataView,\n  byteOffset: number,\n  options: ParseGLBOptions\n): number {\n  // Sanity: ensure file is big enough to hold at least the first chunk header\n  assert(glb.header.byteLength > GLB_FILE_HEADER_SIZE + GLB_CHUNK_HEADER_SIZE);\n\n  parseGLBChunksSync(glb, dataView, byteOffset, options);\n\n  return byteOffset + glb.header.byteLength;\n}\n\n/** Iterate over GLB chunks and parse them */\nfunction parseGLBChunksSync(\n  glb: GLB,\n  dataView: DataView,\n  byteOffset: number,\n  options: ParseGLBOptions\n) {\n  // Per spec we must iterate over chunks, ignoring all except JSON and BIN\n  // Iterate as long as there is space left for another chunk header\n  while (byteOffset + 8 <= glb.header.byteLength) {\n    const chunkLength = dataView.getUint32(byteOffset + 0, LITTLE_ENDIAN); // Byte length of chunk\n    const chunkFormat = dataView.getUint32(byteOffset + 4, LITTLE_ENDIAN); // Chunk format as uint32\n    byteOffset += GLB_CHUNK_HEADER_SIZE;\n\n    // Per spec we must iterate over chunks, ignoring all except JSON and BIN\n    switch (chunkFormat) {\n      case GLB_CHUNK_TYPE_JSON:\n        parseJSONChunk(glb, dataView, byteOffset, chunkLength);\n        break;\n      case GLB_CHUNK_TYPE_BIN:\n        parseBINChunk(glb, dataView, byteOffset, chunkLength);\n        break;\n\n      // Backward compatibility for very old xviz files\n      case GLB_CHUNK_TYPE_JSON_XVIZ_DEPRECATED:\n        if (!options.strict) {\n          parseJSONChunk(glb, dataView, byteOffset, chunkLength);\n        }\n        break;\n      case GLB_CHUNK_TYPE_BIX_XVIZ_DEPRECATED:\n        if (!options.strict) {\n          parseBINChunk(glb, dataView, byteOffset, chunkLength);\n        }\n        break;\n\n      default:\n        // Ignore, per spec\n        // console.warn(`Unknown GLB chunk type`); // eslint-disable-line\n        break;\n    }\n\n    byteOffset += padToNBytes(chunkLength, 4);\n  }\n\n  return byteOffset;\n}\n\n/* Parse a GLB JSON chunk */\nfunction parseJSONChunk(glb: GLB, dataView: DataView, byteOffset: number, chunkLength: number) {\n  // 1. Create a \"view\" of the binary encoded JSON data inside the GLB\n  const jsonChunk = new Uint8Array(dataView.buffer, byteOffset, chunkLength);\n\n  // 2. Decode the JSON binary array into clear text\n  const textDecoder = new TextDecoder('utf8');\n  const jsonText = textDecoder.decode(jsonChunk);\n\n  // 3. Parse the JSON text into a JavaScript data structure\n  glb.json = JSON.parse(jsonText);\n\n  return padToNBytes(chunkLength, 4);\n}\n\n/** Parse a GLB BIN chunk */\nfunction parseBINChunk(glb: GLB, dataView, byteOffset, chunkLength) {\n  // Note: BIN chunk can be optional\n  glb.header.hasBinChunk = true;\n  glb.binChunks.push({\n    byteOffset,\n    byteLength: chunkLength,\n    arrayBuffer: dataView.buffer\n    // TODO - copy, or create typed array view?\n  });\n\n  return padToNBytes(chunkLength, 4);\n}\n"],"mappings":";;;;;;;AAIA,IAAAA,YAAA,GAAAC,OAAA;AAWA,IAAMC,aAAa,GAAG,IAAI;AAG1B,IAAMC,UAAU,GAAG,UAAU;AAC7B,IAAMC,oBAAoB,GAAG,EAAE;AAC/B,IAAMC,qBAAqB,GAAG,CAAC;AAC/B,IAAMC,mBAAmB,GAAG,UAAU;AACtC,IAAMC,kBAAkB,GAAG,UAAU;AACrC,IAAMC,0BAA0B,GAAG,GAAG;AAGtC,IAAMC,mCAAmC,GAAG,CAAC;AAE7C,IAAMC,kCAAkC,GAAG,CAAC;AAE5C,SAASC,cAAcA,CAACC,QAAQ,EAAkB;EAAA,IAAhBC,UAAU,GAAAC,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAG,CAAC;EAC9C,UAAAG,MAAA,CACAC,MAAM,CAACC,YAAY,CAACP,QAAQ,CAACQ,QAAQ,CAACP,UAAU,GAAG,CAAC,CAAC,CAAC,EAAAI,MAAA,CACtDC,MAAM,CAACC,YAAY,CAACP,QAAQ,CAACQ,QAAQ,CAACP,UAAU,GAAG,CAAC,CAAC,CAAC,EAAAI,MAAA,CACtDC,MAAM,CAACC,YAAY,CAACP,QAAQ,CAACQ,QAAQ,CAACP,UAAU,GAAG,CAAC,CAAC,CAAC,EAAAI,MAAA,CACtDC,MAAM,CAACC,YAAY,CAACP,QAAQ,CAACQ,QAAQ,CAACP,UAAU,GAAG,CAAC,CAAC,CAAC;AACxD;AAGO,SAASQ,KAAKA,CACnBC,WAAwB,EAGf;EAAA,IAFTT,UAAkB,GAAAC,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAG,CAAC;EAAA,IACtBS,OAAwB,GAAAT,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAG,CAAC,CAAC;EAE7B,IAAMF,QAAQ,GAAG,IAAIY,QAAQ,CAACF,WAAW,CAAC;EAE1C,IAAAG,cAAA,GAA6BF,OAAO,CAA7BG,KAAK;IAALA,KAAK,GAAAD,cAAA,cAAGtB,UAAU,GAAAsB,cAAA;EACzB,IAAME,MAAM,GAAGf,QAAQ,CAACgB,SAAS,CAACf,UAAU,EAAE,KAAK,CAAC;EACpD,OAAOc,MAAM,KAAKD,KAAK,IAAIC,MAAM,KAAKxB,UAAU;AAClD;AAUO,SAAS0B,YAAYA,CAC1BC,GAAQ,EACRR,WAAwB,EAGxB;EAAA,IAFAT,UAAkB,GAAAC,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAG,CAAC;EAAA,IACtBS,OAAwB,GAAAT,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAG,CAAC,CAAC;EAG7B,IAAMF,QAAQ,GAAG,IAAIY,QAAQ,CAACF,WAAW,CAAC;EAG1C,IAAMS,IAAI,GAAGpB,cAAc,CAACC,QAAQ,EAAEC,UAAU,GAAG,CAAC,CAAC;EACrD,IAAMmB,OAAO,GAAGpB,QAAQ,CAACgB,SAAS,CAACf,UAAU,GAAG,CAAC,EAAEX,aAAa,CAAC;EACjE,IAAM+B,UAAU,GAAGrB,QAAQ,CAACgB,SAAS,CAACf,UAAU,GAAG,CAAC,EAAEX,aAAa,CAAC;EAEpEgC,MAAM,CAACC,MAAM,CAACL,GAAG,EAAE;IAEjBM,MAAM,EAAE;MACNvB,UAAU,EAAVA,UAAU;MACVoB,UAAU,EAAVA,UAAU;MACVI,WAAW,EAAE;IACf,CAAC;IAEDN,IAAI,EAAJA,IAAI;IACJC,OAAO,EAAPA,OAAO;IAEPM,IAAI,EAAE,CAAC,CAAC;IACRC,SAAS,EAAE;EACb,CAAQ,CAAC;EAET1B,UAAU,IAAIT,oBAAoB;EAElC,QAAQ0B,GAAG,CAACE,OAAO;IACjB,KAAK,CAAC;MACJ,OAAOQ,UAAU,CAACV,GAAG,EAAElB,QAAQ,EAAEC,UAAU,CAAC;IAC9C,KAAK,CAAC;MACJ,OAAO4B,UAAU,CAACX,GAAG,EAAElB,QAAQ,EAAEC,UAAU,EAAGU,OAAO,GAAG,CAAC,CAAE,CAAC;IAC9D;MACE,MAAM,IAAImB,KAAK,wBAAAzB,MAAA,CAAwBa,GAAG,CAACE,OAAO,qCAAkC,CAAC;EACzF;AACF;AASA,SAASQ,UAAUA,CAACV,GAAQ,EAAElB,QAAkB,EAAEC,UAAkB,EAAU;EAE5E,IAAA8B,mBAAM,EAACb,GAAG,CAACM,MAAM,CAACH,UAAU,GAAG7B,oBAAoB,GAAGC,qBAAqB,CAAC;EAI5E,IAAMuC,aAAa,GAAGhC,QAAQ,CAACgB,SAAS,CAACf,UAAU,GAAG,CAAC,EAAEX,aAAa,CAAC;EACvE,IAAM2C,aAAa,GAAGjC,QAAQ,CAACgB,SAAS,CAACf,UAAU,GAAG,CAAC,EAAEX,aAAa,CAAC;EACvEW,UAAU,IAAIR,qBAAqB;EAGnC,IAAAsC,mBAAM,EAACE,aAAa,KAAKrC,0BAA0B,CAAC;EAEpDsC,cAAc,CAAChB,GAAG,EAAElB,QAAQ,EAAEC,UAAU,EAAE+B,aAAa,CAAC;EAExD/B,UAAU,IAAI+B,aAAa;EAC3B/B,UAAU,IAAIkC,aAAa,CAACjB,GAAG,EAAElB,QAAQ,EAAEC,UAAU,EAAEiB,GAAG,CAACM,MAAM,CAACH,UAAU,CAAC;EAE7E,OAAOpB,UAAU;AACnB;AASA,SAAS4B,UAAUA,CACjBX,GAAQ,EACRlB,QAAkB,EAClBC,UAAkB,EAClBU,OAAwB,EAChB;EAER,IAAAoB,mBAAM,EAACb,GAAG,CAACM,MAAM,CAACH,UAAU,GAAG7B,oBAAoB,GAAGC,qBAAqB,CAAC;EAE5E2C,kBAAkB,CAAClB,GAAG,EAAElB,QAAQ,EAAEC,UAAU,EAAEU,OAAO,CAAC;EAEtD,OAAOV,UAAU,GAAGiB,GAAG,CAACM,MAAM,CAACH,UAAU;AAC3C;AAGA,SAASe,kBAAkBA,CACzBlB,GAAQ,EACRlB,QAAkB,EAClBC,UAAkB,EAClBU,OAAwB,EACxB;EAGA,OAAOV,UAAU,GAAG,CAAC,IAAIiB,GAAG,CAACM,MAAM,CAACH,UAAU,EAAE;IAC9C,IAAMgB,WAAW,GAAGrC,QAAQ,CAACgB,SAAS,CAACf,UAAU,GAAG,CAAC,EAAEX,aAAa,CAAC;IACrE,IAAMgD,WAAW,GAAGtC,QAAQ,CAACgB,SAAS,CAACf,UAAU,GAAG,CAAC,EAAEX,aAAa,CAAC;IACrEW,UAAU,IAAIR,qBAAqB;IAGnC,QAAQ6C,WAAW;MACjB,KAAK5C,mBAAmB;QACtBwC,cAAc,CAAChB,GAAG,EAAElB,QAAQ,EAAEC,UAAU,EAAEoC,WAAW,CAAC;QACtD;MACF,KAAK1C,kBAAkB;QACrBwC,aAAa,CAACjB,GAAG,EAAElB,QAAQ,EAAEC,UAAU,EAAEoC,WAAW,CAAC;QACrD;MAGF,KAAKxC,mCAAmC;QACtC,IAAI,CAACc,OAAO,CAAC4B,MAAM,EAAE;UACnBL,cAAc,CAAChB,GAAG,EAAElB,QAAQ,EAAEC,UAAU,EAAEoC,WAAW,CAAC;QACxD;QACA;MACF,KAAKvC,kCAAkC;QACrC,IAAI,CAACa,OAAO,CAAC4B,MAAM,EAAE;UACnBJ,aAAa,CAACjB,GAAG,EAAElB,QAAQ,EAAEC,UAAU,EAAEoC,WAAW,CAAC;QACvD;QACA;MAEF;QAGE;IACJ;IAEApC,UAAU,IAAI,IAAAuC,wBAAW,EAACH,WAAW,EAAE,CAAC,CAAC;EAC3C;EAEA,OAAOpC,UAAU;AACnB;AAGA,SAASiC,cAAcA,CAAChB,GAAQ,EAAElB,QAAkB,EAAEC,UAAkB,EAAEoC,WAAmB,EAAE;EAE7F,IAAMI,SAAS,GAAG,IAAIC,UAAU,CAAC1C,QAAQ,CAAC2C,MAAM,EAAE1C,UAAU,EAAEoC,WAAW,CAAC;EAG1E,IAAMO,WAAW,GAAG,IAAIC,WAAW,CAAC,MAAM,CAAC;EAC3C,IAAMC,QAAQ,GAAGF,WAAW,CAACG,MAAM,CAACN,SAAS,CAAC;EAG9CvB,GAAG,CAACQ,IAAI,GAAGsB,IAAI,CAACC,KAAK,CAACH,QAAQ,CAAC;EAE/B,OAAO,IAAAN,wBAAW,EAACH,WAAW,EAAE,CAAC,CAAC;AACpC;AAGA,SAASF,aAAaA,CAACjB,GAAQ,EAAElB,QAAQ,EAAEC,UAAU,EAAEoC,WAAW,EAAE;EAElEnB,GAAG,CAACM,MAAM,CAACC,WAAW,GAAG,IAAI;EAC7BP,GAAG,CAACS,SAAS,CAACuB,IAAI,CAAC;IACjBjD,UAAU,EAAVA,UAAU;IACVoB,UAAU,EAAEgB,WAAW;IACvB3B,WAAW,EAAEV,QAAQ,CAAC2C;EAExB,CAAC,CAAC;EAEF,OAAO,IAAAH,wBAAW,EAACH,WAAW,EAAE,CAAC,CAAC;AACpC"}