{"version":3,"file":"parse-terrain.js","names":["_schema","require","_martini","_interopRequireDefault","_delatin","_skirt","makeTerrainMeshFromImage","terrainImage","terrainOptions","meshMaxError","bounds","elevationDecoder","data","width","height","terrain","mesh","tesselator","getTerrain","getMartiniTileMesh","getDelatinTileMesh","_mesh","vertices","_mesh2","triangles","attributes","getMeshAttributes","boundingBox","getMeshBoundingBox","skirtHeight","_addSkirt","addSkirt","newAttributes","newTriangles","loaderData","header","vertexCount","length","mode","indices","value","Uint32Array","from","size","gridSize","martini","Martini","tile","createTile","_tile$getMesh","getMesh","tin","Delatin","run","coords","imageData","rScaler","bScaler","gScaler","offset","Float32Array","i","y","x","k","r","g","b","numOfVerticies","positions","texCoords","_ref","_ref2","_slicedToArray2","default","minX","minY","maxX","maxY","xScale","yScale","pixelIdx","POSITION","TEXCOORD_0"],"sources":["../../../src/lib/parse-terrain.ts"],"sourcesContent":["// loaders.gl, MIT license\n\nimport {getMeshBoundingBox} from '@loaders.gl/schema';\nimport Martini from '@mapbox/martini';\nimport Delatin from './delatin';\nimport {addSkirt} from './helpers/skirt';\n\nexport type TerrainOptions = {\n  meshMaxError: number;\n  bounds: number[];\n  elevationDecoder: ElevationDecoder;\n  tesselator: 'martini' | 'delatin' | 'auto';\n  skirtHeight?: number;\n};\n\ntype TerrainImage = {\n  data: Uint8Array;\n  width: number;\n  height: number;\n};\n\ntype ElevationDecoder = {\n  rScaler: any;\n  bScaler: any;\n  gScaler: any;\n  offset: number;\n};\n\n/**\n * Returns generated mesh object from image data\n *\n * @param terrainImage terrain image data\n * @param terrainOptions terrain options\n * @returns mesh object\n */\nexport function makeTerrainMeshFromImage(\n  terrainImage: TerrainImage,\n  terrainOptions: TerrainOptions\n) {\n  const {meshMaxError, bounds, elevationDecoder} = terrainOptions;\n\n  const {data, width, height} = terrainImage;\n\n  let terrain;\n  let mesh;\n  switch (terrainOptions.tesselator) {\n    case 'martini':\n      terrain = getTerrain(data, width, height, elevationDecoder, terrainOptions.tesselator);\n      mesh = getMartiniTileMesh(meshMaxError, width, terrain);\n      break;\n    case 'delatin':\n      terrain = getTerrain(data, width, height, elevationDecoder, terrainOptions.tesselator);\n      mesh = getDelatinTileMesh(meshMaxError, width, height, terrain);\n      break;\n    // auto\n    default:\n      if (width === height && !(height & (width - 1))) {\n        terrain = getTerrain(data, width, height, elevationDecoder, 'martini');\n        mesh = getMartiniTileMesh(meshMaxError, width, terrain);\n      } else {\n        terrain = getTerrain(data, width, height, elevationDecoder, 'delatin');\n        mesh = getDelatinTileMesh(meshMaxError, width, height, terrain);\n      }\n      break;\n  }\n\n  const {vertices} = mesh;\n  let {triangles} = mesh;\n  let attributes = getMeshAttributes(vertices, terrain, width, height, bounds);\n\n  // Compute bounding box before adding skirt so that z values are not skewed\n  const boundingBox = getMeshBoundingBox(attributes);\n\n  if (terrainOptions.skirtHeight) {\n    const {attributes: newAttributes, triangles: newTriangles} = addSkirt(\n      attributes,\n      triangles,\n      terrainOptions.skirtHeight\n    );\n    attributes = newAttributes;\n    triangles = newTriangles;\n  }\n\n  return {\n    // Data return by this loader implementation\n    loaderData: {\n      header: {}\n    },\n    header: {\n      vertexCount: triangles.length,\n      boundingBox\n    },\n    mode: 4, // TRIANGLES\n    indices: {value: Uint32Array.from(triangles), size: 1},\n    attributes\n  };\n}\n\n/**\n * Get Martini generated vertices and triangles\n *\n * @param {number} meshMaxError threshold for simplifying mesh\n * @param {number} width width of the input data\n * @param {number[] | Float32Array} terrain elevation data\n * @returns {{vertices: Uint16Array, triangles: Uint32Array}} vertices and triangles data\n */\nfunction getMartiniTileMesh(meshMaxError, width, terrain) {\n  const gridSize = width + 1;\n  const martini = new Martini(gridSize);\n  const tile = martini.createTile(terrain);\n  const {vertices, triangles} = tile.getMesh(meshMaxError);\n\n  return {vertices, triangles};\n}\n\n/**\n * Get Delatin generated vertices and triangles\n *\n * @param {number} meshMaxError threshold for simplifying mesh\n * @param {number} width width of the input data array\n * @param {number} height height of the input data array\n * @param {number[] | Float32Array} terrain elevation data\n * @returns {{vertices: number[], triangles: number[]}} vertices and triangles data\n */\nfunction getDelatinTileMesh(meshMaxError, width, height, terrain) {\n  const tin = new Delatin(terrain, width + 1, height + 1);\n  tin.run(meshMaxError);\n  // @ts-expect-error\n  const {coords, triangles} = tin;\n  const vertices = coords;\n  return {vertices, triangles};\n}\n\nfunction getTerrain(\n  imageData: Uint8Array,\n  width: number,\n  height: number,\n  elevationDecoder: ElevationDecoder,\n  tesselator: 'martini' | 'delatin'\n) {\n  const {rScaler, bScaler, gScaler, offset} = elevationDecoder;\n\n  // From Martini demo\n  // https://observablehq.com/@mourner/martin-real-time-rtin-terrain-mesh\n  const terrain = new Float32Array((width + 1) * (height + 1));\n  // decode terrain values\n  for (let i = 0, y = 0; y < height; y++) {\n    for (let x = 0; x < width; x++, i++) {\n      const k = i * 4;\n      const r = imageData[k + 0];\n      const g = imageData[k + 1];\n      const b = imageData[k + 2];\n      terrain[i + y] = r * rScaler + g * gScaler + b * bScaler + offset;\n    }\n  }\n\n  if (tesselator === 'martini') {\n    // backfill bottom border\n    for (let i = (width + 1) * width, x = 0; x < width; x++, i++) {\n      terrain[i] = terrain[i - width - 1];\n    }\n    // backfill right border\n    for (let i = height, y = 0; y < height + 1; y++, i += height + 1) {\n      terrain[i] = terrain[i - 1];\n    }\n  }\n\n  return terrain;\n}\n\nfunction getMeshAttributes(\n  vertices,\n  terrain: Uint8Array,\n  width: number,\n  height: number,\n  bounds: number[]\n) {\n  const gridSize = width + 1;\n  const numOfVerticies = vertices.length / 2;\n  // vec3. x, y in pixels, z in meters\n  const positions = new Float32Array(numOfVerticies * 3);\n  // vec2. 1 to 1 relationship with position. represents the uv on the texture image. 0,0 to 1,1.\n  const texCoords = new Float32Array(numOfVerticies * 2);\n\n  const [minX, minY, maxX, maxY] = bounds || [0, 0, width, height];\n  const xScale = (maxX - minX) / width;\n  const yScale = (maxY - minY) / height;\n\n  for (let i = 0; i < numOfVerticies; i++) {\n    const x = vertices[i * 2];\n    const y = vertices[i * 2 + 1];\n    const pixelIdx = y * gridSize + x;\n\n    positions[3 * i + 0] = x * xScale + minX;\n    positions[3 * i + 1] = -y * yScale + maxY;\n    positions[3 * i + 2] = terrain[pixelIdx];\n\n    texCoords[2 * i + 0] = x / width;\n    texCoords[2 * i + 1] = y / height;\n  }\n\n  return {\n    POSITION: {value: positions, size: 3},\n    TEXCOORD_0: {value: texCoords, size: 2}\n    // NORMAL: {}, - optional, but creates the high poly look with lighting\n  };\n}\n"],"mappings":"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"}