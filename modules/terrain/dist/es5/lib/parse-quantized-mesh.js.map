{"version":3,"file":"parse-quantized-mesh.js","names":["_schema","require","_decodeQuantizedMesh","_interopRequireWildcard","_skirt","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","_typeof","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","parseQuantizedMesh","arrayBuffer","options","arguments","length","undefined","bounds","_decode","decode","DECODING_STEPS","triangleIndices","header","vertexData","originalTriangleIndices","westIndices","northIndices","eastIndices","southIndices","attributes","getMeshAttributes","boundingBox","getMeshBoundingBox","skirtHeight","_addSkirt","addSkirt","newAttributes","newTriangles","triangles","loaderData","vertexCount","schema","topology","mode","indices","value","size","minHeight","maxHeight","_ref","_ref2","_slicedToArray2","minX","minY","maxX","maxY","xScale","yScale","zScale","nCoords","positions","Float32Array","texCoords","i","x","y","z","POSITION","TEXCOORD_0"],"sources":["../../../src/lib/parse-quantized-mesh.ts"],"sourcesContent":["import {Mesh, getMeshBoundingBox} from '@loaders.gl/schema';\nimport decode, {DECODING_STEPS} from './decode-quantized-mesh';\nimport {addSkirt} from './helpers/skirt';\n\nexport type ParseQuantizedMeshOptions = {\n  bounds?: [number, number, number, number];\n  skirtHeight?: number | null;\n};\n\nexport function parseQuantizedMesh(\n  arrayBuffer: ArrayBuffer,\n  options: ParseQuantizedMeshOptions = {}\n): Mesh {\n  const {bounds} = options;\n  // Don't parse edge indices or format extensions\n  const {\n    header,\n    vertexData,\n    triangleIndices: originalTriangleIndices,\n    westIndices,\n    northIndices,\n    eastIndices,\n    southIndices\n  } = decode(arrayBuffer, DECODING_STEPS.triangleIndices);\n  let triangleIndices = originalTriangleIndices;\n  let attributes = getMeshAttributes(vertexData, header, bounds);\n\n  // Compute bounding box before adding skirt so that z values are not skewed\n  // TODO: Find bounding box from header, instead of doing extra pass over\n  // vertices.\n  const boundingBox = getMeshBoundingBox(attributes);\n\n  if (options?.skirtHeight) {\n    const {attributes: newAttributes, triangles: newTriangles} = addSkirt(\n      attributes,\n      triangleIndices,\n      options.skirtHeight,\n      {\n        westIndices,\n        northIndices,\n        eastIndices,\n        southIndices\n      }\n    );\n    attributes = newAttributes;\n    triangleIndices = newTriangles;\n  }\n\n  return {\n    // Data return by this loader implementation\n    loaderData: {\n      header: {}\n    },\n    header: {\n      // @ts-ignore\n      vertexCount: triangleIndices.length,\n      boundingBox\n    },\n    // TODO\n    schema: undefined!,\n    topology: 'triangle-list',\n    mode: 4, // TRIANGLES\n    indices: {value: triangleIndices, size: 1},\n    attributes\n  };\n}\n\nfunction getMeshAttributes(vertexData, header, bounds) {\n  const {minHeight, maxHeight} = header;\n  const [minX, minY, maxX, maxY] = bounds || [0, 0, 1, 1];\n  const xScale = maxX - minX;\n  const yScale = maxY - minY;\n  const zScale = maxHeight - minHeight;\n\n  const nCoords = vertexData.length / 3;\n  // vec3. x, y defined by bounds, z in meters\n  const positions = new Float32Array(nCoords * 3);\n\n  // vec2. 1 to 1 relationship with position. represents the uv on the texture image. 0,0 to 1,1.\n  const texCoords = new Float32Array(nCoords * 2);\n\n  // Data is not interleaved; all u, then all v, then all heights\n  for (let i = 0; i < nCoords; i++) {\n    const x = vertexData[i] / 32767;\n    const y = vertexData[i + nCoords] / 32767;\n    const z = vertexData[i + nCoords * 2] / 32767;\n\n    positions[3 * i + 0] = x * xScale + minX;\n    positions[3 * i + 1] = y * yScale + minY;\n    positions[3 * i + 2] = z * zScale + minHeight;\n\n    texCoords[2 * i + 0] = x;\n    texCoords[2 * i + 1] = y;\n  }\n\n  return {\n    POSITION: {value: positions, size: 3},\n    TEXCOORD_0: {value: texCoords, size: 2}\n    // TODO: Parse normals if they exist in the file\n    // NORMAL: {}, - optional, but creates the high poly look with lighting\n  };\n}\n"],"mappings":"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"}