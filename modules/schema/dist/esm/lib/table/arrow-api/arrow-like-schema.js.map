{"version":3,"file":"arrow-like-schema.js","names":["ArrowLikeField","ArrowLikeSchema","constructor","fields","metadata","arguments","length","undefined","Map","_defineProperty","map","field","name","type","nullable","Object","entries","compareTo","other","i","select","nameMap","create","_len","columnNames","Array","_key","selectedFields","filter","selectAt","_len2","columnIndices","_key2","index","Boolean","assign","schemaOrFields","otherArrowLikeSchema","mergeMaps","fieldMap","mergedFields","values","m1","m2"],"sources":["../../../../../src/lib/table/arrow-api/arrow-like-schema.ts"],"sourcesContent":["// loaders.gl, MIT license\n\nimport {SchemaMetadata, Field} from '../../../types/schema';\nimport {ArrowLikeField} from './arrow-like-field';\n\nexport class ArrowLikeSchema {\n  fields: ArrowLikeField[];\n  metadata: Map<string, string>;\n\n  constructor(\n    fields: ArrowLikeField[] | Field[],\n    metadata: SchemaMetadata | Map<string, string> = new Map<string, string>()\n  ) {\n    // checkNames(fields);\n    // For kepler fields, create arrow compatible `Fields` that have kepler fields as `metadata`\n    this.fields = fields.map(\n      (field) => new ArrowLikeField(field.name, field.type, field.nullable, field.metadata)\n    );\n    this.metadata =\n      metadata instanceof Map ? metadata : new Map<string, string>(Object.entries(metadata));\n  }\n\n  // TODO - arrow only seems to compare fields, not metadata\n  compareTo(other: ArrowLikeSchema): boolean {\n    if (this.metadata !== other.metadata) {\n      return false;\n    }\n    if (this.fields.length !== other.fields.length) {\n      return false;\n    }\n    for (let i = 0; i < this.fields.length; ++i) {\n      if (!this.fields[i].compareTo(other.fields[i])) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  select(...columnNames: string[]): ArrowLikeSchema {\n    // Ensure column names reference valid fields\n    const nameMap = Object.create(null);\n    for (const name of columnNames) {\n      nameMap[name] = true;\n    }\n    const selectedFields = this.fields.filter((field) => nameMap[field.name]);\n    return new ArrowLikeSchema(selectedFields, this.metadata);\n  }\n\n  selectAt(...columnIndices: number[]): ArrowLikeSchema {\n    // Ensure column indices reference valid fields\n    const selectedFields = columnIndices.map((index) => this.fields[index]).filter(Boolean);\n    return new ArrowLikeSchema(selectedFields, this.metadata);\n  }\n\n  assign(schemaOrFields: ArrowLikeSchema | ArrowLikeField[]): ArrowLikeSchema {\n    let fields: ArrowLikeField[];\n    let metadata = this.metadata;\n\n    if (schemaOrFields instanceof ArrowLikeSchema) {\n      const otherArrowLikeSchema = schemaOrFields;\n      fields = otherArrowLikeSchema.fields;\n      metadata = mergeMaps(mergeMaps(new Map(), this.metadata), otherArrowLikeSchema.metadata);\n    } else {\n      fields = schemaOrFields;\n    }\n\n    // Create a merged list of fields, overwrite fields in place, new fields at end\n    const fieldMap: {[key: string]: ArrowLikeField} = Object.create(null);\n\n    for (const field of this.fields) {\n      fieldMap[field.name] = field;\n    }\n\n    for (const field of fields) {\n      fieldMap[field.name] = field;\n    }\n\n    const mergedFields = Object.values(fieldMap);\n\n    return new ArrowLikeSchema(mergedFields, metadata);\n  }\n}\n\n// Warn if any duplicated field names\n// function checkNames(fields: Field[]): void {\n//   const usedNames: Record<string, boolean> = {};\n//   for (const field of fields) {\n//     if (usedNames[field.name]) {\n//       // eslint-disable-next-line\n//       console.warn('ArrowLikeSchema: duplicated field name', field.name, field);\n//     }\n//     usedNames[field.name] = true;\n//   }\n// }\n\nfunction mergeMaps<T>(m1: T, m2: T): T {\n  // @ts-ignore\n  return new Map([...(m1 || new Map()), ...(m2 || new Map())]);\n}\n"],"mappings":"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"}