{"version":3,"file":"lz4-compression.js","names":["toArrayBuffer","Compression","LZ4_MAGIC_NUMBER","lz4js","LZ4Compression","constructor","options","_this$options","_this$options$modules","_defineProperty","modules","Error","name","compressSync","input","inputArray","Uint8Array","compress","buffer","decompressSync","data","maxSize","isMagicNumberExists","checkMagicNumber","decompress","error","improveError","uncompressed","uncompressedSize","decodeBlock","slice","output","startIndex","endIndex","length","index","token","literalsLength","end","offset","matchLength","pos","magic","Uint32Array"],"sources":["../../../src/lib/lz4-compression.ts"],"sourcesContent":["// Copyright (c) 2012 Pierre Curto\n\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\n/* eslint-disable complexity */\n/* eslint-disable max-statements */\n\n// LZ4\nimport {toArrayBuffer} from '@loaders.gl/loader-utils';\nimport type {CompressionOptions} from './compression';\nimport {Compression} from './compression';\n// import lz4js from 'lz4js'; // https://bundlephobia.com/package/lz4\nconst LZ4_MAGIC_NUMBER = 0x184d2204;\n\nlet lz4js;\n\n/**\n * LZ4 compression / decompression\n */\nexport class LZ4Compression extends Compression {\n  readonly name: string = 'lz4';\n  readonly extensions = ['lz4'];\n  readonly contentEncodings = ['x-lz4'];\n  readonly isSupported = true;\n  readonly options: CompressionOptions;\n\n  constructor(options: CompressionOptions) {\n    super(options);\n    this.options = options;\n\n    lz4js = lz4js || this.options?.modules?.lz4js;\n    if (!lz4js) {\n      throw new Error(this.name);\n    }\n  }\n\n  compressSync(input: ArrayBuffer): ArrayBuffer {\n    const inputArray = new Uint8Array(input);\n    return lz4js.compress(inputArray).buffer;\n  }\n\n  /**\n   * Decompresses an ArrayBuffer containing an Lz4 frame. maxSize is optional; if not\n   * provided, a maximum size will be determined by examining the data. The\n   * returned ArrayBuffer will always be perfectly sized.\n   * If data provided without magic number we will parse it as block\n   */\n  decompressSync(data: ArrayBuffer, maxSize?: number): ArrayBuffer {\n    try {\n      const isMagicNumberExists = this.checkMagicNumber(data);\n      const inputArray = new Uint8Array(data);\n\n      if (isMagicNumberExists) {\n        return lz4js.decompress(inputArray, maxSize).buffer;\n      }\n\n      if (!maxSize) {\n        const error = new Error('Need to provide maxSize');\n        throw this.improveError(error);\n      }\n\n      let uncompressed = new Uint8Array(maxSize);\n      const uncompressedSize = this.decodeBlock(inputArray, uncompressed);\n      uncompressed = uncompressed.slice(0, uncompressedSize);\n\n      return toArrayBuffer(uncompressed);\n    } catch (error) {\n      throw this.improveError(error);\n    }\n  }\n\n  /**\n   * Decode lz4 file as block\n   * Solution taken from here\n   * https://github.com/pierrec/node-lz4/blob/0dac687262403fd34f905b963da7220692f2a4a1/lib/binding.js#L25\n   * @param input\n   * @param output\n   * @param startIndex\n   * @param endIndex\n   */\n  decodeBlock(\n    data: Uint8Array,\n    output: Uint8Array,\n    startIndex?: number,\n    endIndex?: number\n  ): number {\n    startIndex = startIndex || 0;\n    endIndex = endIndex || data.length - startIndex;\n\n    let uncompressedSize = 0;\n    // Process each sequence in the incoming data\n    for (let index = startIndex; index < endIndex; ) {\n      const token = data[index++];\n\n      // Literals\n      let literalsLength = token >> 4;\n\n      if (literalsLength > 0) {\n        // length of literals\n        let length = literalsLength + 240;\n\n        while (length === 255) {\n          length = data[index++];\n          literalsLength += length;\n        }\n\n        // Copy the literals\n        const end = index + literalsLength;\n\n        while (index < end) {\n          output[uncompressedSize++] = data[index++];\n        }\n\n        // End of buffer?\n        if (index === endIndex) {\n          return uncompressedSize;\n        }\n      }\n\n      // Match copy\n      // 2 bytes offset (little endian)\n      const offset = data[index++] | (data[index++] << 8);\n\n      // 0 is an invalid offset value\n      if (offset === 0 || offset > uncompressedSize) {\n        return -(index - 2);\n      }\n\n      // length of match copy\n      let matchLength = token & 0xf;\n      let length = matchLength + 240;\n\n      while (length === 255) {\n        length = data[index++];\n        matchLength += length;\n      }\n\n      // Copy the match\n      let pos = uncompressedSize - offset; // position of the match copy in the current output\n      const end = uncompressedSize + matchLength + 4; // minmatch = 4\n\n      while (uncompressedSize < end) {\n        output[uncompressedSize++] = output[pos++];\n      }\n    }\n\n    return uncompressedSize;\n  }\n\n  /**\n   * Compare file magic with lz4 magic number\n   * @param input\n   */\n  checkMagicNumber(data: ArrayBuffer): boolean {\n    const magic = new Uint32Array(data.slice(0, 4));\n    return magic[0] === LZ4_MAGIC_NUMBER;\n  }\n}\n"],"mappings":"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"}