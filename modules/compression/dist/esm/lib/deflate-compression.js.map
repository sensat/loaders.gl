{"version":3,"file":"deflate-compression.js","names":["Compression","isBrowser","toArrayBuffer","pako","zlib","promisify1","DeflateCompression","constructor","options","arguments","length","undefined","_defineProperty","compress","input","_this$options$deflate","deflate","useZlib","_this$options$deflate2","buffer","gzip","compressSync","decompress","_this$options$deflate3","_this$options$deflate4","gunzip","inflate","decompressSync","_this$options$deflate5","_this$options","_this$options$deflate6","gzipSync","deflateSync","pakoOptions","inputArray","Uint8Array","_this$options$deflate7","_this$options2","_this$options$deflate8","gunzipSync","inflateSync","compressBatches","asyncIterator","_this$options3","pakoProcessor","Deflate","transformBatches","decompressBatches","_this$options4","Inflate","onData","_onData","bind","onEnd","_onEnd","chunk","uint8Array","ok","push","Error","concat","_getError","chunks","_getChunks","emptyChunk","_chunks","status","code","MESSAGES","name"],"sources":["../../../src/lib/deflate-compression.ts"],"sourcesContent":["// DEFLATE\nimport type {CompressionOptions} from './compression';\nimport {Compression} from './compression';\nimport {isBrowser, toArrayBuffer} from '@loaders.gl/loader-utils';\nimport pako from 'pako'; // https://bundlephobia.com/package/pako\nimport zlib from 'zlib';\nimport {promisify1} from '@loaders.gl/loader-utils';\n\nexport type DeflateCompressionOptions = CompressionOptions & {\n  deflate?: pako.InflateOptions & pako.DeflateOptions & {useZlib?: boolean};\n};\n\n/**\n * DEFLATE compression / decompression\n */\nexport class DeflateCompression extends Compression {\n  readonly name: string = 'deflate';\n  readonly extensions: string[] = [];\n  readonly contentEncodings = ['deflate'];\n  readonly isSupported = true;\n\n  readonly options: DeflateCompressionOptions;\n\n  private _chunks: ArrayBuffer[] = [];\n\n  constructor(options: DeflateCompressionOptions = {}) {\n    super(options);\n    this.options = options;\n  }\n\n  async compress(input: ArrayBuffer): Promise<ArrayBuffer> {\n    // On Node.js we can use built-in zlib\n    if (!isBrowser && this.options.deflate?.useZlib) {\n      const buffer = this.options.deflate?.gzip\n        ? await promisify1(zlib.gzip)(input)\n        : await promisify1(zlib.deflate)(input);\n      return toArrayBuffer(buffer);\n    }\n    return this.compressSync(input);\n  }\n\n  async decompress(input: ArrayBuffer): Promise<ArrayBuffer> {\n    // On Node.js we can use built-in zlib\n    if (!isBrowser && this.options.deflate?.useZlib) {\n      const buffer = this.options.deflate?.gzip\n        ? await promisify1(zlib.gunzip)(input)\n        : await promisify1(zlib.inflate)(input);\n      return toArrayBuffer(buffer);\n    }\n    return this.decompressSync(input);\n  }\n\n  compressSync(input: ArrayBuffer): ArrayBuffer {\n    // On Node.js we can use built-in zlib\n    if (!isBrowser && this.options.deflate?.useZlib) {\n      const buffer = this.options.deflate?.gzip ? zlib.gzipSync(input) : zlib.deflateSync(input);\n      return toArrayBuffer(buffer);\n    }\n    const pakoOptions: pako.DeflateOptions = this.options?.deflate || {};\n    const inputArray = new Uint8Array(input);\n    return pako.deflate(inputArray, pakoOptions).buffer;\n  }\n\n  decompressSync(input: ArrayBuffer): ArrayBuffer {\n    // On Node.js we can use built-in zlib\n    if (!isBrowser && this.options.deflate?.useZlib) {\n      const buffer = this.options.deflate?.gzip ? zlib.gunzipSync(input) : zlib.inflateSync(input);\n      return toArrayBuffer(buffer);\n    }\n    const pakoOptions: pako.InflateOptions = this.options?.deflate || {};\n    const inputArray = new Uint8Array(input);\n    return pako.inflate(inputArray, pakoOptions).buffer;\n  }\n\n  async *compressBatches(\n    asyncIterator: AsyncIterable<ArrayBuffer> | Iterable<ArrayBuffer>\n  ): AsyncIterable<ArrayBuffer> {\n    const pakoOptions: pako.DeflateOptions = this.options?.deflate || {};\n    const pakoProcessor = new pako.Deflate(pakoOptions);\n    yield* this.transformBatches(pakoProcessor, asyncIterator);\n  }\n\n  async *decompressBatches(\n    asyncIterator: AsyncIterable<ArrayBuffer> | Iterable<ArrayBuffer>\n  ): AsyncIterable<ArrayBuffer> {\n    const pakoOptions: pako.InflateOptions = this.options?.deflate || {};\n    const pakoProcessor = new pako.Inflate(pakoOptions);\n    yield* this.transformBatches(pakoProcessor, asyncIterator);\n  }\n\n  async *transformBatches(\n    pakoProcessor: pako.Inflate | pako.Deflate,\n    asyncIterator: AsyncIterable<ArrayBuffer> | Iterable<ArrayBuffer>\n  ): AsyncIterable<ArrayBuffer> {\n    pakoProcessor.onData = this._onData.bind(this);\n    pakoProcessor.onEnd = this._onEnd.bind(this);\n    for await (const chunk of asyncIterator) {\n      const uint8Array = new Uint8Array(chunk);\n      const ok = pakoProcessor.push(uint8Array, false); // false -> not last chunk\n      if (!ok) {\n        throw new Error(`${this._getError()}write`);\n      }\n      const chunks = this._getChunks();\n      yield* chunks;\n    }\n\n    // End\n    const emptyChunk = new Uint8Array(0);\n    const ok = pakoProcessor.push(emptyChunk, true); // true -> last chunk\n    if (!ok) {\n      // For some reason we get error but it still works???\n      // throw new Error(this._getError() + 'end');\n    }\n    const chunks = this._getChunks();\n    yield* chunks;\n  }\n\n  _onData(chunk) {\n    this._chunks.push(chunk);\n  }\n\n  _onEnd(status) {\n    if (status !== 0) {\n      throw new Error(this._getError(status) + this._chunks.length);\n    }\n  }\n\n  _getChunks(): ArrayBuffer[] {\n    const chunks = this._chunks;\n    this._chunks = [];\n    return chunks;\n  }\n\n  // TODO - For some reason we don't get the error message from pako in _onEnd?\n  _getError(code: number = 0): string {\n    const MESSAGES = {\n      /* Z_NEED_DICT       2  */\n      2: 'need dictionary',\n      /* Z_STREAM_END      1  */\n      1: 'stream end',\n      /* Z_OK              0  */\n      0: '',\n      /* Z_ERRNO         (-1) */\n      '-1': 'file error',\n      /* Z_STREAM_ERROR  (-2) */\n      '-2': 'stream error',\n      /* Z_DATA_ERROR    (-3) */\n      '-3': 'data error',\n      /* Z_MEM_ERROR     (-4) */\n      '-4': 'insufficient memory',\n      /* Z_BUF_ERROR     (-5) */\n      '-5': 'buffer error',\n      /* Z_VERSION_ERROR (-6) */\n      '-6': 'incompatible version'\n    };\n    return `${this.name}: ${MESSAGES[code]}`;\n  }\n}\n"],"mappings":"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"}