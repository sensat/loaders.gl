{"version":3,"file":"parse-i3s-attribute.js","names":["_constants","require","_createForOfIteratorHelper","o","allowArrayLike","it","Symbol","iterator","Array","isArray","_unsupportedIterableToArray","length","i","F","s","n","done","value","e","_e","f","TypeError","normalCompletion","didErr","err","call","step","next","_e2","return","minLen","_arrayLikeToArray","Object","prototype","toString","slice","constructor","name","from","test","arr","len","arr2","parseI3STileAttribute","arrayBuffer","options","attributeName","attributeType","_defineProperty2","default","parseAttribute","STRING_ATTRIBUTE_TYPE","parseStringsAttribute","OBJECT_ID_ATTRIBUTE_TYPE","parseShortNumberAttribute","FLOAT_64_TYPE","parseFloatAttribute","INT_16_ATTRIBUTE_TYPE","parseInt16ShortNumberAttribute","countOffset","Uint32Array","Int16Array","Float64Array","stringsCountOffset","dataOffset","bytesPerStringSize","stringsArray","stringsCount","DataView","getUint32","stringSizes","stringOffset","_iterator","_step","stringByteSize","textDecoder","TextDecoder","stringAttribute","Uint8Array","push","decode","error","console","message"],"sources":["../../../../src/lib/parsers/parse-i3s-attribute.ts"],"sourcesContent":["// loaders.gl, MIT license\n\nimport {TypedArray} from '@loaders.gl/schema';\n\nimport {\n  STRING_ATTRIBUTE_TYPE,\n  OBJECT_ID_ATTRIBUTE_TYPE,\n  FLOAT_64_TYPE,\n  INT_16_ATTRIBUTE_TYPE\n} from './constants';\n\ntype Attribute = string[] | TypedArray | null;\nexport type I3STileAttributes = Record<string, Attribute>;\n\n/**\n * Get particular tile and creates attribute object inside.\n * @param  arrayBuffer\n * @param {Object} options\n * @returns {Promise<object>}\n */\nexport function parseI3STileAttribute(arrayBuffer: ArrayBuffer, options): I3STileAttributes {\n  const {attributeName, attributeType} = options;\n\n  if (!attributeName) {\n    return {};\n  }\n  return {\n    [attributeName]: attributeType ? parseAttribute(attributeType, arrayBuffer) : null\n  };\n}\n\n/**\n * Parse attributes based on attribute type.\n * @param {String} attributeType\n * @param  arrayBuffer\n * @returns\n */\nfunction parseAttribute(attributeType, arrayBuffer: ArrayBuffer): Attribute {\n  switch (attributeType) {\n    case STRING_ATTRIBUTE_TYPE:\n      return parseStringsAttribute(arrayBuffer);\n    case OBJECT_ID_ATTRIBUTE_TYPE:\n      return parseShortNumberAttribute(arrayBuffer);\n    case FLOAT_64_TYPE:\n      return parseFloatAttribute(arrayBuffer);\n    case INT_16_ATTRIBUTE_TYPE:\n      return parseInt16ShortNumberAttribute(arrayBuffer);\n    default:\n      return parseShortNumberAttribute(arrayBuffer);\n  }\n}\n\n/**\n * Parse short number attribute.\n * Short Integer spec - https://github.com/Esri/i3s-spec/blob/master/docs/1.7/attributeStorageInfo.cmn.md\n * @param  arrayBuffer\n * @returns\n */\nfunction parseShortNumberAttribute(arrayBuffer: ArrayBuffer): Uint32Array {\n  const countOffset = 4;\n  return new Uint32Array(arrayBuffer, countOffset);\n}\n\n/**\n * Parse Int16 short number attribute.\n * Parsing of such data is not documented. Added to handle Building Scene Layer Tileset attributes data.\n * @param  arrayBuffer\n * @returns\n */\nfunction parseInt16ShortNumberAttribute(arrayBuffer: ArrayBuffer): Int16Array {\n  const countOffset = 4;\n  return new Int16Array(arrayBuffer, countOffset);\n}\n\n/**\n * Parse float attribute.\n * Double Spec - https://github.com/Esri/i3s-spec/blob/master/docs/1.7/attributeStorageInfo.cmn.md\n * @param  arrayBuffer\n * @returns\n */\nfunction parseFloatAttribute(arrayBuffer: ArrayBuffer): Float64Array {\n  const countOffset = 8;\n  return new Float64Array(arrayBuffer, countOffset);\n}\n\n/**\n * Parse string attribute.\n * String spec - https://github.com/Esri/i3s-spec/blob/master/docs/1.7/attributeStorageInfo.cmn.md\n * @param arrayBuffer\n * @returns list of strings\n */\nfunction parseStringsAttribute(arrayBuffer: ArrayBuffer): string[] {\n  const stringsCountOffset = 0;\n  const dataOffset = 8;\n  const bytesPerStringSize = 4;\n  const stringsArray: string[] = [];\n\n  try {\n    // Use DataView to avoid multiple of 4 error on Uint32Array constructor\n    const stringsCount = new DataView(\n      arrayBuffer,\n      stringsCountOffset,\n      bytesPerStringSize\n    ).getUint32(stringsCountOffset, true);\n    const stringSizes = new Uint32Array(arrayBuffer, dataOffset, stringsCount);\n    let stringOffset = dataOffset + stringsCount * bytesPerStringSize;\n\n    for (const stringByteSize of stringSizes) {\n      const textDecoder = new TextDecoder('utf-8');\n      const stringAttribute = new Uint8Array(arrayBuffer, stringOffset, stringByteSize);\n      stringsArray.push(textDecoder.decode(stringAttribute));\n      stringOffset += stringByteSize;\n    }\n  } catch (error) {\n    console.error('Parse string attribute error: ', (error as Error).message); // eslint-disable-line\n  }\n\n  return stringsArray;\n}\n"],"mappings":";;;;;;;;AAIA,IAAAA,UAAA,GAAAC,OAAA;AAKqB,SAAAC,2BAAAC,CAAA,EAAAC,cAAA,QAAAC,EAAA,UAAAC,MAAA,oBAAAH,CAAA,CAAAG,MAAA,CAAAC,QAAA,KAAAJ,CAAA,qBAAAE,EAAA,QAAAG,KAAA,CAAAC,OAAA,CAAAN,CAAA,MAAAE,EAAA,GAAAK,2BAAA,CAAAP,CAAA,MAAAC,cAAA,IAAAD,CAAA,WAAAA,CAAA,CAAAQ,MAAA,qBAAAN,EAAA,EAAAF,CAAA,GAAAE,EAAA,MAAAO,CAAA,UAAAC,CAAA,YAAAA,EAAA,eAAAC,CAAA,EAAAD,CAAA,EAAAE,CAAA,WAAAA,EAAA,QAAAH,CAAA,IAAAT,CAAA,CAAAQ,MAAA,WAAAK,IAAA,mBAAAA,IAAA,SAAAC,KAAA,EAAAd,CAAA,CAAAS,CAAA,UAAAM,CAAA,WAAAA,EAAAC,EAAA,UAAAA,EAAA,KAAAC,CAAA,EAAAP,CAAA,gBAAAQ,SAAA,iJAAAC,gBAAA,SAAAC,MAAA,UAAAC,GAAA,WAAAV,CAAA,WAAAA,EAAA,IAAAT,EAAA,GAAAA,EAAA,CAAAoB,IAAA,CAAAtB,CAAA,MAAAY,CAAA,WAAAA,EAAA,QAAAW,IAAA,GAAArB,EAAA,CAAAsB,IAAA,IAAAL,gBAAA,GAAAI,IAAA,CAAAV,IAAA,SAAAU,IAAA,KAAAR,CAAA,WAAAA,EAAAU,GAAA,IAAAL,MAAA,SAAAC,GAAA,GAAAI,GAAA,KAAAR,CAAA,WAAAA,EAAA,eAAAE,gBAAA,IAAAjB,EAAA,CAAAwB,MAAA,UAAAxB,EAAA,CAAAwB,MAAA,oBAAAN,MAAA,QAAAC,GAAA;AAAA,SAAAd,4BAAAP,CAAA,EAAA2B,MAAA,SAAA3B,CAAA,qBAAAA,CAAA,sBAAA4B,iBAAA,CAAA5B,CAAA,EAAA2B,MAAA,OAAAf,CAAA,GAAAiB,MAAA,CAAAC,SAAA,CAAAC,QAAA,CAAAT,IAAA,CAAAtB,CAAA,EAAAgC,KAAA,aAAApB,CAAA,iBAAAZ,CAAA,CAAAiC,WAAA,EAAArB,CAAA,GAAAZ,CAAA,CAAAiC,WAAA,CAAAC,IAAA,MAAAtB,CAAA,cAAAA,CAAA,mBAAAP,KAAA,CAAA8B,IAAA,CAAAnC,CAAA,OAAAY,CAAA,+DAAAwB,IAAA,CAAAxB,CAAA,UAAAgB,iBAAA,CAAA5B,CAAA,EAAA2B,MAAA;AAAA,SAAAC,kBAAAS,GAAA,EAAAC,GAAA,QAAAA,GAAA,YAAAA,GAAA,GAAAD,GAAA,CAAA7B,MAAA,EAAA8B,GAAA,GAAAD,GAAA,CAAA7B,MAAA,WAAAC,CAAA,MAAA8B,IAAA,OAAAlC,KAAA,CAAAiC,GAAA,GAAA7B,CAAA,GAAA6B,GAAA,EAAA7B,CAAA,IAAA8B,IAAA,CAAA9B,CAAA,IAAA4B,GAAA,CAAA5B,CAAA,UAAA8B,IAAA;AAWd,SAASC,qBAAqBA,CAACC,WAAwB,EAAEC,OAAO,EAAqB;EAC1F,IAAOC,aAAa,GAAmBD,OAAO,CAAvCC,aAAa;IAAEC,aAAa,GAAIF,OAAO,CAAxBE,aAAa;EAEnC,IAAI,CAACD,aAAa,EAAE;IAClB,OAAO,CAAC,CAAC;EACX;EACA,WAAAE,gBAAA,CAAAC,OAAA,MACGH,aAAa,EAAGC,aAAa,GAAGG,cAAc,CAACH,aAAa,EAAEH,WAAW,CAAC,GAAG,IAAI;AAEtF;AAQA,SAASM,cAAcA,CAACH,aAAa,EAAEH,WAAwB,EAAa;EAC1E,QAAQG,aAAa;IACnB,KAAKI,gCAAqB;MACxB,OAAOC,qBAAqB,CAACR,WAAW,CAAC;IAC3C,KAAKS,mCAAwB;MAC3B,OAAOC,yBAAyB,CAACV,WAAW,CAAC;IAC/C,KAAKW,wBAAa;MAChB,OAAOC,mBAAmB,CAACZ,WAAW,CAAC;IACzC,KAAKa,gCAAqB;MACxB,OAAOC,8BAA8B,CAACd,WAAW,CAAC;IACpD;MACE,OAAOU,yBAAyB,CAACV,WAAW,CAAC;EACjD;AACF;AAQA,SAASU,yBAAyBA,CAACV,WAAwB,EAAe;EACxE,IAAMe,WAAW,GAAG,CAAC;EACrB,OAAO,IAAIC,WAAW,CAAChB,WAAW,EAAEe,WAAW,CAAC;AAClD;AAQA,SAASD,8BAA8BA,CAACd,WAAwB,EAAc;EAC5E,IAAMe,WAAW,GAAG,CAAC;EACrB,OAAO,IAAIE,UAAU,CAACjB,WAAW,EAAEe,WAAW,CAAC;AACjD;AAQA,SAASH,mBAAmBA,CAACZ,WAAwB,EAAgB;EACnE,IAAMe,WAAW,GAAG,CAAC;EACrB,OAAO,IAAIG,YAAY,CAAClB,WAAW,EAAEe,WAAW,CAAC;AACnD;AAQA,SAASP,qBAAqBA,CAACR,WAAwB,EAAY;EACjE,IAAMmB,kBAAkB,GAAG,CAAC;EAC5B,IAAMC,UAAU,GAAG,CAAC;EACpB,IAAMC,kBAAkB,GAAG,CAAC;EAC5B,IAAMC,YAAsB,GAAG,EAAE;EAEjC,IAAI;IAEF,IAAMC,YAAY,GAAG,IAAIC,QAAQ,CAC/BxB,WAAW,EACXmB,kBAAkB,EAClBE,kBACF,CAAC,CAACI,SAAS,CAACN,kBAAkB,EAAE,IAAI,CAAC;IACrC,IAAMO,WAAW,GAAG,IAAIV,WAAW,CAAChB,WAAW,EAAEoB,UAAU,EAAEG,YAAY,CAAC;IAC1E,IAAII,YAAY,GAAGP,UAAU,GAAGG,YAAY,GAAGF,kBAAkB;IAAC,IAAAO,SAAA,GAAAtE,0BAAA,CAErCoE,WAAW;MAAAG,KAAA;IAAA;MAAxC,KAAAD,SAAA,CAAA1D,CAAA,MAAA2D,KAAA,GAAAD,SAAA,CAAAzD,CAAA,IAAAC,IAAA,GAA0C;QAAA,IAA/B0D,cAAc,GAAAD,KAAA,CAAAxD,KAAA;QACvB,IAAM0D,WAAW,GAAG,IAAIC,WAAW,CAAC,OAAO,CAAC;QAC5C,IAAMC,eAAe,GAAG,IAAIC,UAAU,CAAClC,WAAW,EAAE2B,YAAY,EAAEG,cAAc,CAAC;QACjFR,YAAY,CAACa,IAAI,CAACJ,WAAW,CAACK,MAAM,CAACH,eAAe,CAAC,CAAC;QACtDN,YAAY,IAAIG,cAAc;MAChC;IAAC,SAAAlD,GAAA;MAAAgD,SAAA,CAAAtD,CAAA,CAAAM,GAAA;IAAA;MAAAgD,SAAA,CAAApD,CAAA;IAAA;EACH,CAAC,CAAC,OAAO6D,KAAK,EAAE;IACdC,OAAO,CAACD,KAAK,CAAC,gCAAgC,EAAGA,KAAK,CAAWE,OAAO,CAAC;EAC3E;EAEA,OAAOjB,YAAY;AACrB"}