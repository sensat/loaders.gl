{"version":3,"file":"parse-slpk.js","names":["parseZipCDFileHeader","parseZipLocalFileHeader","SLPKArchive","getByteAt","offset","buffer","getUint8","byteOffset","parseSLPK","data","_options$slpk$path","_options$slpk","_options$slpk2","options","arguments","length","undefined","archive","DataView","cdFileHeaderSignature","searchWindow","byteLength","hashCDOffset","i","every","val","index","cdFileHeader","textDecoder","TextDecoder","decode","fileName","Error","localFileHeader","localHeaderOffset","fileDataOffset","hashFile","slice","compressedSize","getFile","slpk","path","pathMode"],"sources":["../../../../../src/lib/parsers/parse-slpk/parse-slpk.ts"],"sourcesContent":["import type {SLPKLoaderOptions} from '../../../i3s-slpk-loader';\nimport {parseZipCDFileHeader} from '../parse-zip/cd-file-header';\nimport {parseZipLocalFileHeader} from '../parse-zip/local-file-header';\nimport {SLPKArchive} from './slpk-archieve';\n\n/**\n * Returns one byte from the provided buffer at the provided position\n * @param offset - position where to read\n * @param buffer - buffer to read\n * @returns one byte from the provided buffer at the provided position\n */\nconst getByteAt = (offset: number, buffer: DataView): number => {\n  return buffer.getUint8(buffer.byteOffset + offset);\n};\n\nexport async function parseSLPK(data: ArrayBuffer, options: SLPKLoaderOptions = {}) {\n  const archive = new DataView(data);\n  const cdFileHeaderSignature = [80, 75, 1, 2];\n\n  const searchWindow = [\n    getByteAt(archive.byteLength - 1, archive),\n    getByteAt(archive.byteLength - 2, archive),\n    getByteAt(archive.byteLength - 3, archive),\n    undefined\n  ];\n\n  let hashCDOffset = 0;\n\n  // looking for the last record in the central directory\n  for (let i = archive.byteLength - 4; i > -1; i--) {\n    searchWindow[3] = searchWindow[2];\n    searchWindow[2] = searchWindow[1];\n    searchWindow[1] = searchWindow[0];\n    searchWindow[0] = getByteAt(i, archive);\n    if (searchWindow.every((val, index) => val === cdFileHeaderSignature[index])) {\n      hashCDOffset = i;\n      break;\n    }\n  }\n\n  const cdFileHeader = parseZipCDFileHeader(hashCDOffset, archive);\n\n  const textDecoder = new TextDecoder();\n  if (textDecoder.decode(cdFileHeader.fileName) !== '@specialIndexFileHASH128@') {\n    throw new Error('No hash file in slpk');\n  }\n\n  const localFileHeader = parseZipLocalFileHeader(cdFileHeader.localHeaderOffset, archive);\n\n  const fileDataOffset = localFileHeader.fileDataOffset;\n  const hashFile = archive.buffer.slice(\n    fileDataOffset,\n    fileDataOffset + localFileHeader.compressedSize\n  );\n\n  if (!hashFile) {\n    throw new Error('No hash file in slpk');\n  }\n\n  return await new SLPKArchive(data, hashFile).getFile(\n    options.slpk?.path ?? '',\n    options.slpk?.pathMode\n  );\n}\n"],"mappings":"AACA,SAAQA,oBAAoB,QAAO,6BAA6B;AAChE,SAAQC,uBAAuB,QAAO,gCAAgC;AACtE,SAAQC,WAAW,QAAO,iBAAiB;AAQ3C,MAAMC,SAAS,GAAGA,CAACC,MAAc,EAAEC,MAAgB,KAAa;EAC9D,OAAOA,MAAM,CAACC,QAAQ,CAACD,MAAM,CAACE,UAAU,GAAGH,MAAM,CAAC;AACpD,CAAC;AAED,OAAO,eAAeI,SAASA,CAACC,IAAiB,EAAmC;EAAA,IAAAC,kBAAA,EAAAC,aAAA,EAAAC,cAAA;EAAA,IAAjCC,OAA0B,GAAAC,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAG,CAAC,CAAC;EAChF,MAAMG,OAAO,GAAG,IAAIC,QAAQ,CAACT,IAAI,CAAC;EAClC,MAAMU,qBAAqB,GAAG,CAAC,EAAE,EAAE,EAAE,EAAE,CAAC,EAAE,CAAC,CAAC;EAE5C,MAAMC,YAAY,GAAG,CACnBjB,SAAS,CAACc,OAAO,CAACI,UAAU,GAAG,CAAC,EAAEJ,OAAO,CAAC,EAC1Cd,SAAS,CAACc,OAAO,CAACI,UAAU,GAAG,CAAC,EAAEJ,OAAO,CAAC,EAC1Cd,SAAS,CAACc,OAAO,CAACI,UAAU,GAAG,CAAC,EAAEJ,OAAO,CAAC,EAC1CD,SAAS,CACV;EAED,IAAIM,YAAY,GAAG,CAAC;EAGpB,KAAK,IAAIC,CAAC,GAAGN,OAAO,CAACI,UAAU,GAAG,CAAC,EAAEE,CAAC,GAAG,CAAC,CAAC,EAAEA,CAAC,EAAE,EAAE;IAChDH,YAAY,CAAC,CAAC,CAAC,GAAGA,YAAY,CAAC,CAAC,CAAC;IACjCA,YAAY,CAAC,CAAC,CAAC,GAAGA,YAAY,CAAC,CAAC,CAAC;IACjCA,YAAY,CAAC,CAAC,CAAC,GAAGA,YAAY,CAAC,CAAC,CAAC;IACjCA,YAAY,CAAC,CAAC,CAAC,GAAGjB,SAAS,CAACoB,CAAC,EAAEN,OAAO,CAAC;IACvC,IAAIG,YAAY,CAACI,KAAK,CAAC,CAACC,GAAG,EAAEC,KAAK,KAAKD,GAAG,KAAKN,qBAAqB,CAACO,KAAK,CAAC,CAAC,EAAE;MAC5EJ,YAAY,GAAGC,CAAC;MAChB;IACF;EACF;EAEA,MAAMI,YAAY,GAAG3B,oBAAoB,CAACsB,YAAY,EAAEL,OAAO,CAAC;EAEhE,MAAMW,WAAW,GAAG,IAAIC,WAAW,CAAC,CAAC;EACrC,IAAID,WAAW,CAACE,MAAM,CAACH,YAAY,CAACI,QAAQ,CAAC,KAAK,2BAA2B,EAAE;IAC7E,MAAM,IAAIC,KAAK,CAAC,sBAAsB,CAAC;EACzC;EAEA,MAAMC,eAAe,GAAGhC,uBAAuB,CAAC0B,YAAY,CAACO,iBAAiB,EAAEjB,OAAO,CAAC;EAExF,MAAMkB,cAAc,GAAGF,eAAe,CAACE,cAAc;EACrD,MAAMC,QAAQ,GAAGnB,OAAO,CAACZ,MAAM,CAACgC,KAAK,CACnCF,cAAc,EACdA,cAAc,GAAGF,eAAe,CAACK,cACnC,CAAC;EAED,IAAI,CAACF,QAAQ,EAAE;IACb,MAAM,IAAIJ,KAAK,CAAC,sBAAsB,CAAC;EACzC;EAEA,OAAO,MAAM,IAAI9B,WAAW,CAACO,IAAI,EAAE2B,QAAQ,CAAC,CAACG,OAAO,EAAA7B,kBAAA,IAAAC,aAAA,GAClDE,OAAO,CAAC2B,IAAI,cAAA7B,aAAA,uBAAZA,aAAA,CAAc8B,IAAI,cAAA/B,kBAAA,cAAAA,kBAAA,GAAI,EAAE,GAAAE,cAAA,GACxBC,OAAO,CAAC2B,IAAI,cAAA5B,cAAA,uBAAZA,cAAA,CAAc8B,QAChB,CAAC;AACH"}