{"version":3,"file":"parse-arcgis-webscene.js","names":["JSONLoader","load","SUPPORTED_WKID","ARCGIS_SCENE_SERVER_LAYER_TYPE","BUILDING_SCENE_LAYER","INTEGRATED_MESH_LAYER","GROUP_LAYER","SUPPORTED_LAYERS_TYPES","NO_AVAILABLE_SUPPORTED_LAYERS_ERROR","NOT_SUPPORTED_CRS_ERROR","parseWebscene","data","layer0","JSON","parse","TextDecoder","decode","operationalLayers","layers","unsupportedLayers","parseOperationalLayers","length","Error","header","layersList","needToCheckCRS","index","_layer$layers","layer","isLayerSupported","includes","layerType","checkSupportedIndexCRS","push","childLayers","childUnsupportedLayers","_layerJson$spatialRef","layerJson","url","wkid","spatialReference","error"],"sources":["../../../../src/lib/parsers/parse-arcgis-webscene.ts"],"sourcesContent":["import {JSONLoader, load} from '@loaders.gl/core';\nimport type {ArcGisWebSceneData, OperationalLayer} from '../../types';\n\n/**\n * WKID, or Well-Known ID, of the CRS. Specify either WKID or WKT of the CRS.\n * Spec - https://github.com/Esri/i3s-spec/blob/master/docs/1.8/spatialReference.cmn.md\n */\nconst SUPPORTED_WKID = 4326;\n\nconst ARCGIS_SCENE_SERVER_LAYER_TYPE = 'ArcGISSceneServiceLayer';\nconst BUILDING_SCENE_LAYER = 'BuildingSceneLayer';\nconst INTEGRATED_MESH_LAYER = 'IntegratedMeshLayer';\nconst GROUP_LAYER = 'GroupLayer';\n\n/**\n * Supported layers list\n * Possible operational layers in WebScene: https://developers.arcgis.com/web-scene-specification/objects/operationalLayers/\n */\nconst SUPPORTED_LAYERS_TYPES = [\n  ARCGIS_SCENE_SERVER_LAYER_TYPE,\n  INTEGRATED_MESH_LAYER,\n  BUILDING_SCENE_LAYER,\n  GROUP_LAYER\n];\n\nconst NO_AVAILABLE_SUPPORTED_LAYERS_ERROR = 'NO_AVAILABLE_SUPPORTED_LAYERS_ERROR';\nconst NOT_SUPPORTED_CRS_ERROR = 'NOT_SUPPORTED_CRS_ERROR';\n\n/**\n * Parses ArcGIS WebScene\n * @param data\n */\nexport async function parseWebscene(data: ArrayBuffer): Promise<ArcGisWebSceneData> {\n  const layer0 = JSON.parse(new TextDecoder().decode(data));\n  const {operationalLayers} = layer0;\n  const {layers, unsupportedLayers} = await parseOperationalLayers(operationalLayers, true);\n\n  if (!layers.length) {\n    throw new Error(NO_AVAILABLE_SUPPORTED_LAYERS_ERROR);\n  }\n\n  return {\n    header: layer0,\n    layers,\n    unsupportedLayers\n  };\n}\n\n/**\n * Recursively parses WebScene operational layers.\n * @param layersList\n */\nasync function parseOperationalLayers(\n  layersList: OperationalLayer[],\n  needToCheckCRS: boolean\n): Promise<{layers: OperationalLayer[]; unsupportedLayers: OperationalLayer[]}> {\n  const layers: OperationalLayer[] = [];\n  let unsupportedLayers: OperationalLayer[] = [];\n\n  for (let index = 0; index < layersList.length; index++) {\n    const layer = layersList[index];\n    const isLayerSupported = SUPPORTED_LAYERS_TYPES.includes(layer.layerType);\n\n    if (isLayerSupported) {\n      if (needToCheckCRS && layer.layerType !== GROUP_LAYER) {\n        await checkSupportedIndexCRS(layer);\n        needToCheckCRS = false;\n      }\n\n      layers.push(layer);\n    } else {\n      unsupportedLayers.push(layer);\n    }\n\n    if (layer.layers?.length) {\n      const {layers: childLayers, unsupportedLayers: childUnsupportedLayers} =\n        await parseOperationalLayers(layer.layers, needToCheckCRS);\n      layer.layers = childLayers;\n      unsupportedLayers = [...unsupportedLayers, ...childUnsupportedLayers];\n    }\n  }\n\n  return {layers, unsupportedLayers};\n}\n\n/**\n * Check if layer has supported CRS\n * @param layer\n */\nasync function checkSupportedIndexCRS(layer: OperationalLayer) {\n  try {\n    const layerJson = await load(layer.url, JSONLoader);\n    // @ts-expect-error\n    const wkid = layerJson?.spatialReference?.wkid;\n\n    if (wkid !== SUPPORTED_WKID) {\n      throw new Error(NOT_SUPPORTED_CRS_ERROR);\n    }\n  } catch (error) {\n    throw error;\n  }\n}\n"],"mappings":"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"}